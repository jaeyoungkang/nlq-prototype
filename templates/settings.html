{% extends "layout.html" %}

{% block title %}프로젝트 설정 - BigQuery AI Assistant{% endblock %}

{% block content %}
<div class="p-8 overflow-y-auto w-full">
    <header class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">프로젝트 설정</h1>
        <p class="text-gray-600">분석할 GCP 프로젝트와 BigQuery 테이블을 선택하세요.</p>
    </header>

    <main class="card">
        <div class="space-y-6">
            <!-- GCP Project Selection -->
            <div class="form-group">
                <label class="form-label flex items-center justify-between">
                    GCP Project
                    <button id="refreshProjectsButton" class="text-xs text-orange-600 hover:text-orange-700 flex items-center gap-1" onclick="loadGcpProjects()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        새로고침
                    </button>
                </label>
                <select id="gcpProjectId" class="form-select">
                    <option value="">프로젝트를 선택하세요...</option>
                </select>
            </div>
            
            <!-- BigQuery Tables Selection -->
            <div class="form-group">
                <label class="form-label">BigQuery Tables</label>
                <div id="tablesContainer" class="border border-gray-300 rounded-xl max-h-80 overflow-y-auto bg-white">
                    <div id="tablesPlaceholder" class="p-6 text-sm text-gray-500 text-center">
                        먼저 프로젝트를 선택하세요
                    </div>
                    <div id="tablesList" class="hidden"></div>
                </div>
                <div class="mt-3 flex justify-between items-center text-xs text-gray-500">
                    <span id="tableSelectionStatus">선택된 테이블: 0개</span>
                    <button id="selectAllTablesButton" class="text-orange-600 hover:text-orange-700 disabled:text-gray-400 font-medium" onclick="toggleAllTables()" disabled>
                        전체 선택/해제
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Action Footer -->
    <footer class="mt-8 flex justify-between items-center">
        <div id="saveStatus" class="text-sm font-medium"></div>
        <button id="saveSettingsButton" class="btn btn-primary" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            <span>설정 저장</span>
        </button>
    </footer>
</div>
{% endblock %}

{% block scripts %}
<script>
    let projectTables = [];
    let selectedTables = new Set();

    const elements = {
        gcpProjectId: document.getElementById('gcpProjectId'),
        tablesContainer: document.getElementById('tablesContainer'),
        tablesPlaceholder: document.getElementById('tablesPlaceholder'),
        tablesList: document.getElementById('tablesList'),
        tableSelectionStatus: document.getElementById('tableSelectionStatus'),
        selectAllTablesButton: document.getElementById('selectAllTablesButton'),
        saveSettingsButton: document.getElementById('saveSettingsButton'),
        saveStatus: document.getElementById('saveStatus'),
    };

    function saveSettings() {
        const projectId = elements.gcpProjectId.value;
        const tableIds = Array.from(selectedTables);

        if (!projectId || tableIds.length === 0) {
            showStatus('프로젝트와 테이블을 하나 이상 선택해주세요.', 'error');
            return;
        }

        localStorage.setItem('bigqueryAISettings', JSON.stringify({ projectId, tableIds }));
        
        showStatus('✅ 설정이 성공적으로 저장되었습니다!', 'success');
        validateInputs();
        
        // Trigger context changed event
        window.dispatchEvent(new Event('contextChanged'));
    }

    function showStatus(message, type = 'info') {
        elements.saveStatus.textContent = message;
        elements.saveStatus.className = `text-sm font-medium ${
            type === 'success' ? 'text-green-600' : 
            type === 'error' ? 'text-red-600' : 'text-gray-600'
        }`;
        
        if (type === 'success') {
            setTimeout(() => { elements.saveStatus.textContent = ''; }, 3000);
        }
    }
    
    function loadSavedSettings() {
        const savedSettings = localStorage.getItem('bigqueryAISettings');
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            selectedTables = new Set(settings.tableIds || []);
            return settings.projectId;
        }
        return null;
    }

    async function loadGcpProjects() {
        const savedProjectId = loadSavedSettings();
        showStatus('프로젝트 목록을 불러오는 중...', 'info');
        
        try {
            const response = await fetch('/api/gcp-projects');
            const result = await response.json();
            if (!result.success) throw new Error(result.error);

            populateProjectDropdown(result.projects, savedProjectId);
            if (elements.gcpProjectId.value) {
               await loadProjectTables();
            }
            showStatus('');
        } catch (error) {
            console.error('GCP 프로젝트 로드 오류:', error);
            showStatus(`프로젝트 로드 실패: ${error.message}`, 'error');
        }
    }

    function populateProjectDropdown(projects, savedProjectId) {
        const select = elements.gcpProjectId;
        while (select.children.length > 1) select.removeChild(select.lastChild);
        
        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.project_id;
            option.textContent = `${project.display_name || project.name} (${project.project_id})`;
            select.appendChild(option);
        });

        if (savedProjectId && projects.some(p => p.project_id === savedProjectId)) {
            select.value = savedProjectId;
        }
    }

    async function loadProjectTables() {
        const projectId = elements.gcpProjectId.value;
        if (!projectId) {
            resetTablesUI();
            return;
        }
        
        elements.tablesPlaceholder.classList.add('hidden');
        elements.tablesList.classList.remove('hidden');
        elements.tablesList.innerHTML = '<div class="p-6 text-sm text-gray-500 text-center flex items-center justify-center gap-2"><div class="loading-dots"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>테이블 목록을 불러오는 중...</div>';

        try {
            const response = await fetch(`/api/gcp-projects/${projectId}/tables`);
            const result = await response.json();
            if (!result.success) throw new Error(result.error);
            
            projectTables = result.tables;
            displayTables(result.tables);
        } catch (error) {
            console.error('테이블 목록 로드 오류:', error);
            elements.tablesList.innerHTML = `<div class="p-6 text-sm text-red-600 text-center">❌ ${error.message}</div>`;
        }
    }

    function displayTables(tables) {
        if (tables.length === 0) {
            elements.tablesList.innerHTML = '<div class="p-6 text-sm text-gray-500 text-center">이 프로젝트에는 테이블이 없습니다</div>';
            return;
        }
        
        // Group tables by dataset
        const tablesByDataset = tables.reduce((acc, table) => {
            (acc[table.dataset_id] = acc[table.dataset_id] || []).push(table);
            return acc;
        }, {});
        
        let html = '';
        Object.keys(tablesByDataset).sort().forEach(datasetId => {
            html += `
                <div class="border-b border-gray-100 last:border-b-0">
                    <div class="px-4 py-3 bg-gray-50 text-xs font-semibold text-gray-700 border-b border-gray-100 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2v0a2 2 0 002-2h10" />
                        </svg>
                        ${datasetId}
                    </div>
            `;
            
            tablesByDataset[datasetId].forEach((table, index) => {
                const isSelected = selectedTables.has(table.table_id);
                const isLast = index === tablesByDataset[datasetId].length - 1;
                
                html += `
                    <div class="px-4 py-3 hover:bg-gray-50 ${!isLast ? 'border-b border-gray-50' : ''} transition-colors">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" class="mr-3 h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500 table-checkbox" 
                                   data-table-id="${table.table_id}" 
                                   ${isSelected ? 'checked' : ''} 
                                   onchange="toggleTableSelection('${table.table_id}')">
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-gray-900 text-sm">${table.table_name}</div>
                                <div class="text-xs text-gray-500 mt-1 flex items-center gap-4">
                                    <span>${(table.num_rows || 0).toLocaleString()} 행</span>
                                    <span>${formatBytes(table.num_bytes || 0)}</span>
                                    ${table.description ? `<span class="truncate max-w-xs" title="${table.description}">${table.description}</span>` : ''}
                                </div>
                            </div>
                        </label>
                    </div>
                `;
            });
            html += '</div>';
        });
        
        elements.tablesList.innerHTML = html;
        elements.selectAllTablesButton.disabled = false;
        updateTableSelectionStatus();
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function toggleTableSelection(tableId) {
        if (selectedTables.has(tableId)) {
            selectedTables.delete(tableId);
        } else {
            selectedTables.add(tableId);
        }
        updateTableSelectionStatus();
    }

    function toggleAllTables() {
        const allSelected = selectedTables.size === projectTables.length;
        selectedTables.clear();
        
        if (!allSelected) {
            projectTables.forEach(table => selectedTables.add(table.table_id));
        }
        
        // Update checkboxes
        document.querySelectorAll('.table-checkbox').forEach(cb => {
            cb.checked = !allSelected;
        });
        
        updateTableSelectionStatus();
    }

    function updateTableSelectionStatus() {
        elements.tableSelectionStatus.textContent = `선택된 테이블: ${selectedTables.size}개`;
        validateInputs();
    }

    function resetTablesUI() {
        elements.tablesPlaceholder.classList.remove('hidden');
        elements.tablesList.classList.add('hidden');
        elements.tablesList.innerHTML = '';
        elements.selectAllTablesButton.disabled = true;
        projectTables = [];
        selectedTables.clear();
        updateTableSelectionStatus();
    }

    function validateInputs() {
        const projectId = elements.gcpProjectId.value;
        const hasSelectedTables = selectedTables.size > 0;
        elements.saveSettingsButton.disabled = !(projectId && hasSelectedTables);
    }
    
    // Event listeners
    elements.gcpProjectId.addEventListener('change', () => {
        selectedTables.clear();
        loadProjectTables();
    });
    
    elements.saveSettingsButton.addEventListener('click', saveSettings);

    // Initialize page
    function initializePage() {
        loadGcpProjects();
        validateInputs();
    }

    if (window.gcpAuthCompleted) {
        initializePage();
    } else {
        window.addEventListener('authComplete', initializePage, { once: true });
    }
</script>
{% endblock %}