{% extends "layout.html" %}

{% block title %}í”„ë¡œíŒŒì¼ - BigQuery AI Assistant{% endblock %}

{% block content %}
<div class="p-8 overflow-y-auto w-full h-full">
    <header class="mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">í”„ë¡œíŒŒì¼</h1>
            <p class="text-gray-600 mt-2">ê³¼ê±°ì— ì‹¤í–‰ëœ í”„ë¡œíŒŒì¼ë§ ì‘ì—… ëª©ë¡ì…ë‹ˆë‹¤. ê° í•­ëª©ì„ í´ë¦­í•˜ì—¬ ìƒì„¸ ë¦¬í¬íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
        </div>
        <button id="refreshButton" class="btn btn-secondary">
            ìƒˆë¡œê³ ì¹¨
        </button>
    </header>

    <main class="card">
        <div class="overflow-x-auto">
            <table class="data-table">
                <thead>
                    <tr>
                        <th scope="col">í”„ë¡œì íŠ¸ ID</th>
                        <th scope="col">í…Œì´ë¸” ìˆ˜</th>
                        <th scope="col">ìƒíƒœ</th>
                        <th scope="col">ì‹œì‘ ì‹œê°„</th>
                        <th scope="col">ì†Œìš” ì‹œê°„</th>
                        <th scope="col" class="text-right">ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="logs-table-body">
                    <!-- Data will be populated here by JavaScript -->
                </tbody>
            </table>
            <div id="loadingState" class="p-6 text-center text-gray-500">ë¡œë”© ì¤‘...</div>
            <div id="errorState" class="p-6 text-center text-red-500 hidden"></div>
            <div id="emptyState" class="p-6 text-center text-gray-500 hidden">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    const elements = {
        tableBody: document.getElementById('logs-table-body'),
        loadingState: document.getElementById('loadingState'),
        errorState: document.getElementById('errorState'),
        emptyState: document.getElementById('emptyState'),
        refreshButton: document.getElementById('refreshButton'),
    };

    async function fetchLogs() {
        elements.loadingState.classList.remove('hidden');
        elements.errorState.classList.add('hidden');
        elements.emptyState.classList.add('hidden');
        elements.tableBody.innerHTML = '';

        try {
            const response = await fetch('/logs');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const logs = await response.json();

            elements.loadingState.classList.add('hidden');

            if (logs.error) {
                throw new Error(logs.error);
            }

            if (logs.length === 0) {
                elements.emptyState.classList.remove('hidden');
                return;
            }
            
            populateTable(logs);

        } catch (e) {
            elements.loadingState.classList.add('hidden');
            elements.errorState.textContent = `ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}`;
            elements.errorState.classList.remove('hidden');
        }
    }
    
    function populateTable(logs) {
        const selectedProfileJSON = localStorage.getItem('selectedProfile');
        const selectedProfileId = selectedProfileJSON ? JSON.parse(selectedProfileJSON).id : null;
        
        const settingsJSON = localStorage.getItem('bigqueryAISettings');
        const settings = settingsJSON ? JSON.parse(settingsJSON) : null;
        const settingsTableIds = settings ? new Set(settings.tableIds.sort()) : null;

        const areSetsEqual = (a, b) => {
            if (!a || !b) return false;
            if (a.size !== b.size) return false;
            const sortedA = [...a].sort();
            const sortedB = [...b].sort();
            for (let i = 0; i < sortedA.length; i++) {
                if (sortedA[i] !== sortedB[i]) return false;
            }
            return true;
        };

        logs.forEach(log => {
            const mainRow = document.createElement('tr');
            mainRow.className = 'log-item cursor-pointer hover:bg-gray-50';
            mainRow.dataset.sessionId = log.id;
            mainRow.dataset.detailsLoaded = 'false';

            const statusMapping = {
                'ì™„ë£Œ': { class: 'badge-success', label: 'ì™„ë£Œ' },
                'ì‹¤íŒ¨': { class: 'badge-error', label: 'ì‹¤íŒ¨' },
                'ì§„í–‰ ì¤‘': { class: 'badge-warning', label: 'ì§„í–‰ ì¤‘' }
            };
            const statusInfo = statusMapping[log.status] || { class: 'badge-gray', label: log.status };

            const startTime = new Date(log.start_time);
            const endTime = log.end_time ? new Date(log.end_time) : null;
            let duration = 'ì§„í–‰ ì¤‘';
            if(endTime) {
                const diffSeconds = ((endTime - startTime) / 1000);
                if (diffSeconds < 60) {
                    duration = `${diffSeconds.toFixed(1)}ì´ˆ`;
                } else {
                    duration = `${(diffSeconds / 60).toFixed(1)}ë¶„`;
                }
            }
            
            const isCurrentlySelected = log.id === selectedProfileId;
            let isSelectable = true;
            let disabledTitle = '';

            if (settingsTableIds) {
                const profileTableIds = new Set((log.table_ids || []).sort());
                if (!areSetsEqual(settingsTableIds, profileTableIds)) {
                    isSelectable = false;
                    disabledTitle = 'í˜„ì¬ í”„ë¡œì íŠ¸ ì„¤ì •ì˜ í…Œì´ë¸” êµ¬ì„±ê³¼ ë‹¤ë¦…ë‹ˆë‹¤.';
                }
            }

            mainRow.innerHTML = `
                <td class="font-medium text-gray-900 whitespace-nowrap">${log.project_id}</td>
                <td>${log.table_ids ? log.table_ids.length : 0}</td>
                <td>
                    <span class="badge ${statusInfo.class}">${statusInfo.label}</span>
                </td>
                <td>${startTime.toLocaleString('ko-KR')}</td>
                <td>${duration}</td>
                <td class="text-right">
                    <button class="select-profile-btn btn btn-secondary text-xs py-1 px-3 ${isCurrentlySelected || !isSelectable ? 'opacity-50 cursor-not-allowed' : ''}" 
                            data-session-id="${log.id}" 
                            data-project-id="${log.project_id}" 
                            data-table-ids='${JSON.stringify(log.table_ids || [])}'
                            title="${disabledTitle}"
                            ${isCurrentlySelected || !isSelectable ? 'disabled' : ''}>
                        ${isCurrentlySelected ? 'ì„ íƒë¨' : 'ì„ íƒ'}
                    </button>
                </td>
            `;
            elements.tableBody.appendChild(mainRow);

            const detailsRow = document.createElement('tr');
            detailsRow.className = 'log-details hidden';
            detailsRow.innerHTML = `<td colspan="6" class="p-0 bg-gray-100 details-content border-b"></td>`;
            elements.tableBody.appendChild(detailsRow);
        });
    }

    async function toggleDetails(rowElement) {
        const detailsRow = rowElement.nextElementSibling;
        const detailsContent = detailsRow.querySelector('.details-content');

        const isHidden = detailsRow.classList.contains('hidden');
        if (!isHidden) {
            detailsRow.classList.add('hidden');
            rowElement.classList.remove('bg-indigo-50');
            return;
        }

        // ë‹¤ë¥¸ ëª¨ë“  ìƒì„¸ ë‚´ìš© ë‹«ê¸°
        document.querySelectorAll('.log-details').forEach(row => row.classList.add('hidden'));
        document.querySelectorAll('.log-item').forEach(row => row.classList.remove('bg-indigo-50'));
        
        detailsRow.classList.remove('hidden');
        rowElement.classList.add('bg-indigo-50');

        if (rowElement.dataset.detailsLoaded === 'false') {
            detailsContent.innerHTML = '<div class="text-center text-gray-500 p-4">ìƒì„¸ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            try {
                const sessionId = rowElement.dataset.sessionId;
                const response = await fetch(`/logs/${sessionId}`);
                if (!response.ok) throw new Error('ìƒì„¸ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);

                let reportHtml = '<p class="p-6">ìƒì„¸ ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                if (data.profiling_report) {
                    if (data.profiling_report.sections && Object.keys(data.profiling_report.sections).length > 0) {
                        const sections = data.profiling_report.sections;
                        const sectionOrder = ["overview", "table_analysis", "relationships", "business_questions", "recommendations"];
                        const sectionInfo = {
                            "overview": { title: "1. ğŸ“‹ ë°ì´í„°ì…‹ ê°œìš”", color: "border-blue-500" },
                            "table_analysis": { title: "2. ğŸ” í…Œì´ë¸” ìƒì„¸ ë¶„ì„", color: "border-green-500" },
                            "relationships": { title: "3. ğŸ”— í…Œì´ë¸” ê°„ ê´€ê³„", color: "border-purple-500" },
                            "business_questions": { title: "4. â“ ë¶„ì„ ê°€ëŠ¥ ì§ˆë¬¸", color: "border-yellow-500" },
                            "recommendations": { title: "5. ğŸ’¡ í™œìš© ê¶Œì¥ì‚¬í•­", color: "border-indigo-500" }
                        };

                        let sectionsHtml = '<div class="p-4 md:p-6 space-y-4">';
                        for (const key of sectionOrder) {
                            if (sections[key]) {
                                sectionsHtml += `
                                <div class="bg-white rounded-lg shadow-sm border-l-4 ${sectionInfo[key].color}">
                                    <h3 class="text-base md:text-lg font-semibold text-gray-800 p-4 flex items-center">
                                        ${sectionInfo[key].title}
                                    </h3>
                                    <div class="p-4 pt-0 prose prose-sm max-w-none text-gray-600">
                                        ${marked.parse(sections[key])}
                                    </div>
                                </div>`;
                            }
                        }
                        sectionsHtml += '</div>';
                        reportHtml = sectionsHtml;
                    } else if (data.profiling_report.full_report) {
                        reportHtml = `<article class="prose prose-sm max-w-none p-6">${marked.parse(data.profiling_report.full_report)}</article>`;
                    }
                }
                detailsContent.innerHTML = reportHtml;
                rowElement.dataset.detailsLoaded = 'true';
            } catch (e) {
                detailsContent.innerHTML = `<div class="text-red-500 p-6">ì˜¤ë¥˜: ${e.message}</div>`;
            }
        }
    }

    function initializePage() {
        fetchLogs();
        elements.refreshButton.addEventListener('click', fetchLogs);
        
        elements.tableBody.addEventListener('click', (event) => {
            const selectBtn = event.target.closest('.select-profile-btn');
            if (selectBtn && !selectBtn.disabled) {
                event.stopPropagation();
                const profile = {
                    id: selectBtn.dataset.sessionId,
                    projectId: selectBtn.dataset.projectId,  
                    tableIds: JSON.parse(selectBtn.dataset.tableIds)
                };
                localStorage.setItem('selectedProfile', JSON.stringify(profile));
                window.dispatchEvent(new Event('contextChanged'));
                
                // ëª¨ë“  ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                document.querySelectorAll('.select-profile-btn').forEach(btn => {
                    if (!btn.title && !btn.disabled) { // ì„ íƒ ê°€ëŠ¥í•œ ë²„íŠ¼ë“¤ë§Œ
                        btn.textContent = 'ì„ íƒ';
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                });
                
                // ì„ íƒëœ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                selectBtn.textContent = 'ì„ íƒë¨';
                selectBtn.disabled = true;
                selectBtn.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }

            const row = event.target.closest('.log-item');
            if (row) {
                toggleDetails(row);
            }
        });
    }

    if (window.gcpAuthCompleted) {
        initializePage();
    } else {
        window.addEventListener('authComplete', initializePage, { once: true });
    }
</script>
{% endblock %}