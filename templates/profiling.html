{% extends "layout.html" %}

{% block title %}프로파일 - BigQuery AI Assistant{% endblock %}

{% block content %}
<div class="p-8 overflow-y-auto w-full h-full">
    <header class="mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">프로파일</h1>
            <p class="text-gray-600 mt-2">과거에 실행된 프로파일링 작업 목록입니다. 각 항목을 클릭하여 상세 리포트를 확인하세요.</p>
        </div>
        <button id="refreshButton" class="btn btn-secondary">
            새로고침
        </button>
    </header>

    <main class="card">
        <div class="overflow-x-auto">
            <table class="data-table">
                <thead>
                    <tr>
                        <th scope="col">프로젝트 ID</th>
                        <th scope="col">테이블 수</th>
                        <th scope="col">상태</th>
                        <th scope="col">시작 시간</th>
                        <th scope="col">소요 시간</th>
                        <th scope="col" class="text-right">작업</th>
                    </tr>
                </thead>
                <tbody id="logs-table-body">
                    <!-- Data will be populated here by JavaScript -->
                </tbody>
            </table>
            <div id="loadingState" class="p-6 text-center text-gray-500">로딩 중...</div>
            <div id="errorState" class="p-6 text-center text-red-500 hidden"></div>
            <div id="emptyState" class="p-6 text-center text-gray-500 hidden">기록이 없습니다.</div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    const elements = {
        tableBody: document.getElementById('logs-table-body'),
        loadingState: document.getElementById('loadingState'),
        errorState: document.getElementById('errorState'),
        emptyState: document.getElementById('emptyState'),
        refreshButton: document.getElementById('refreshButton'),
    };

    async function fetchLogs() {
        elements.loadingState.classList.remove('hidden');
        elements.errorState.classList.add('hidden');
        elements.emptyState.classList.add('hidden');
        elements.tableBody.innerHTML = '';

        try {
            const response = await fetch('/logs');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const logs = await response.json();

            elements.loadingState.classList.add('hidden');

            if (logs.error) {
                throw new Error(logs.error);
            }

            if (logs.length === 0) {
                elements.emptyState.classList.remove('hidden');
                return;
            }
            
            populateTable(logs);

        } catch (e) {
            elements.loadingState.classList.add('hidden');
            elements.errorState.textContent = `데이터를 불러오는 중 오류가 발생했습니다: ${e.message}`;
            elements.errorState.classList.remove('hidden');
        }
    }
    
    function populateTable(logs) {
        const selectedProfileJSON = localStorage.getItem('selectedProfile');
        const selectedProfileId = selectedProfileJSON ? JSON.parse(selectedProfileJSON).id : null;
        
        const settingsJSON = localStorage.getItem('bigqueryAISettings');
        const settings = settingsJSON ? JSON.parse(settingsJSON) : null;
        const settingsTableIds = settings ? new Set(settings.tableIds.sort()) : null;

        const areSetsEqual = (a, b) => {
            if (!a || !b) return false;
            if (a.size !== b.size) return false;
            const sortedA = [...a].sort();
            const sortedB = [...b].sort();
            for (let i = 0; i < sortedA.length; i++) {
                if (sortedA[i] !== sortedB[i]) return false;
            }
            return true;
        };

        logs.forEach(log => {
            const mainRow = document.createElement('tr');
            mainRow.className = 'log-item cursor-pointer hover:bg-gray-50';
            mainRow.dataset.sessionId = log.id;
            mainRow.dataset.detailsLoaded = 'false';

            const statusMapping = {
                '완료': { class: 'badge-success', label: '완료' },
                '실패': { class: 'badge-error', label: '실패' },
                '진행 중': { class: 'badge-warning', label: '진행 중' }
            };
            const statusInfo = statusMapping[log.status] || { class: 'badge-gray', label: log.status };

            const startTime = new Date(log.start_time);
            const endTime = log.end_time ? new Date(log.end_time) : null;
            let duration = '진행 중';
            if(endTime) {
                const diffSeconds = ((endTime - startTime) / 1000);
                if (diffSeconds < 60) {
                    duration = `${diffSeconds.toFixed(1)}초`;
                } else {
                    duration = `${(diffSeconds / 60).toFixed(1)}분`;
                }
            }
            
            const isCurrentlySelected = log.id === selectedProfileId;
            let isSelectable = true;
            let disabledTitle = '';

            if (settingsTableIds) {
                const profileTableIds = new Set((log.table_ids || []).sort());
                if (!areSetsEqual(settingsTableIds, profileTableIds)) {
                    isSelectable = false;
                    disabledTitle = '현재 프로젝트 설정의 테이블 구성과 다릅니다.';
                }
            }

            mainRow.innerHTML = `
                <td class="font-medium text-gray-900 whitespace-nowrap">${log.project_id}</td>
                <td>${log.table_ids ? log.table_ids.length : 0}</td>
                <td>
                    <span class="badge ${statusInfo.class}">${statusInfo.label}</span>
                </td>
                <td>${startTime.toLocaleString('ko-KR')}</td>
                <td>${duration}</td>
                <td class="text-right">
                    <button class="select-profile-btn btn btn-secondary text-xs py-1 px-3 ${isCurrentlySelected || !isSelectable ? 'opacity-50 cursor-not-allowed' : ''}" 
                            data-session-id="${log.id}" 
                            data-project-id="${log.project_id}" 
                            data-table-ids='${JSON.stringify(log.table_ids || [])}'
                            title="${disabledTitle}"
                            ${isCurrentlySelected || !isSelectable ? 'disabled' : ''}>
                        ${isCurrentlySelected ? '선택됨' : '선택'}
                    </button>
                </td>
            `;
            elements.tableBody.appendChild(mainRow);

            const detailsRow = document.createElement('tr');
            detailsRow.className = 'log-details hidden';
            detailsRow.innerHTML = `<td colspan="6" class="p-0 bg-gray-100 details-content border-b"></td>`;
            elements.tableBody.appendChild(detailsRow);
        });
    }

    async function toggleDetails(rowElement) {
        const detailsRow = rowElement.nextElementSibling;
        const detailsContent = detailsRow.querySelector('.details-content');

        const isHidden = detailsRow.classList.contains('hidden');
        if (!isHidden) {
            detailsRow.classList.add('hidden');
            rowElement.classList.remove('bg-indigo-50');
            return;
        }

        // 다른 모든 상세 내용 닫기
        document.querySelectorAll('.log-details').forEach(row => row.classList.add('hidden'));
        document.querySelectorAll('.log-item').forEach(row => row.classList.remove('bg-indigo-50'));
        
        detailsRow.classList.remove('hidden');
        rowElement.classList.add('bg-indigo-50');

        if (rowElement.dataset.detailsLoaded === 'false') {
            detailsContent.innerHTML = '<div class="text-center text-gray-500 p-4">상세 내용을 불러오는 중...</div>';
            try {
                const sessionId = rowElement.dataset.sessionId;
                const response = await fetch(`/logs/${sessionId}`);
                if (!response.ok) throw new Error('상세 내용을 불러오지 못했습니다.');
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);

                let reportHtml = '<p class="p-6">상세 리포트가 없습니다.</p>';
                if (data.profiling_report) {
                    if (data.profiling_report.sections && Object.keys(data.profiling_report.sections).length > 0) {
                        const sections = data.profiling_report.sections;
                        const sectionOrder = ["overview", "table_analysis", "relationships", "business_questions", "recommendations"];
                        const sectionInfo = {
                            "overview": { title: "1. 📋 데이터셋 개요", color: "border-blue-500" },
                            "table_analysis": { title: "2. 🔍 테이블 상세 분석", color: "border-green-500" },
                            "relationships": { title: "3. 🔗 테이블 간 관계", color: "border-purple-500" },
                            "business_questions": { title: "4. ❓ 분석 가능 질문", color: "border-yellow-500" },
                            "recommendations": { title: "5. 💡 활용 권장사항", color: "border-indigo-500" }
                        };

                        let sectionsHtml = '<div class="p-4 md:p-6 space-y-4">';
                        for (const key of sectionOrder) {
                            if (sections[key]) {
                                sectionsHtml += `
                                <div class="bg-white rounded-lg shadow-sm border-l-4 ${sectionInfo[key].color}">
                                    <h3 class="text-base md:text-lg font-semibold text-gray-800 p-4 flex items-center">
                                        ${sectionInfo[key].title}
                                    </h3>
                                    <div class="p-4 pt-0 prose prose-sm max-w-none text-gray-600">
                                        ${marked.parse(sections[key])}
                                    </div>
                                </div>`;
                            }
                        }
                        sectionsHtml += '</div>';
                        reportHtml = sectionsHtml;
                    } else if (data.profiling_report.full_report) {
                        reportHtml = `<article class="prose prose-sm max-w-none p-6">${marked.parse(data.profiling_report.full_report)}</article>`;
                    }
                }
                detailsContent.innerHTML = reportHtml;
                rowElement.dataset.detailsLoaded = 'true';
            } catch (e) {
                detailsContent.innerHTML = `<div class="text-red-500 p-6">오류: ${e.message}</div>`;
            }
        }
    }

    function initializePage() {
        fetchLogs();
        elements.refreshButton.addEventListener('click', fetchLogs);
        
        elements.tableBody.addEventListener('click', (event) => {
            const selectBtn = event.target.closest('.select-profile-btn');
            if (selectBtn && !selectBtn.disabled) {
                event.stopPropagation();
                const profile = {
                    id: selectBtn.dataset.sessionId,
                    projectId: selectBtn.dataset.projectId,  
                    tableIds: JSON.parse(selectBtn.dataset.tableIds)
                };
                localStorage.setItem('selectedProfile', JSON.stringify(profile));
                window.dispatchEvent(new Event('contextChanged'));
                
                // 모든 버튼 상태 업데이트
                document.querySelectorAll('.select-profile-btn').forEach(btn => {
                    if (!btn.title && !btn.disabled) { // 선택 가능한 버튼들만
                        btn.textContent = '선택';
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                });
                
                // 선택된 버튼 상태 업데이트
                selectBtn.textContent = '선택됨';
                selectBtn.disabled = true;
                selectBtn.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }

            const row = event.target.closest('.log-item');
            if (row) {
                toggleDetails(row);
            }
        });
    }

    if (window.gcpAuthCompleted) {
        initializePage();
    } else {
        window.addEventListener('authComplete', initializePage, { once: true });
    }
</script>
{% endblock %}