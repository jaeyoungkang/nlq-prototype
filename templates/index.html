<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µí•© BigQuery ë°ì´í„° ë¶„ì„ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif; }
        .status-item.completed .icon { color: #22c55e; }
        .status-item.active .icon { animation: spin 1s linear infinite; }
        .status-item.error .icon { color: #ef4444; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        code { font-family: 'D2Coding', 'Courier New', monospace; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        .prose h1, .prose h2, .prose h3 { color: #1f2937; }
        .prose code { background-color: #f3f4f6; padding: 0.125rem 0.25rem; border-radius: 0.25rem; }
        .tab-button.active { background: #4285f4; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .mode-card { transition: all 0.3s ease; }
        .mode-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .analysis-result { max-height: 600px; overflow-y: auto; }
        .chart-container { position: relative; height: 400px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- í—¤ë” -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">ğŸš€ í†µí•© BigQuery ë¶„ì„ê¸°</h1>
            <p class="text-gray-600 text-lg mb-4">Claude AI ê¸°ë°˜ ë™ì  ìŠ¤í‚¤ë§ˆ ë¶„ì„ ë° ìì—°ì–´ ì§ˆì˜ ì‹œìŠ¤í…œ</p>
            <div class="flex justify-center space-x-4 text-sm">
                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full">ì‹¤ì‹œê°„ í”„ë¡œíŒŒì¼ë§</span>
                <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full">3ê°€ì§€ ë¶„ì„ ëª¨ë“œ</span>
                <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full">Claude 3.5 Sonnet</span>
            </div>
        </header>

        <!-- ë©”ì¸ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="bg-white rounded-xl shadow-lg mb-8 border border-gray-200">
            <div class="flex border-b border-gray-200">
                <button id="setupTab" class="tab-button flex-1 py-4 px-6 text-lg font-semibold rounded-tl-xl bg-blue-600 text-white">
                    ğŸ“Š ë°ì´í„° ì„¤ì •
                </button>
                <button id="profilingTab" class="tab-button flex-1 py-4 px-6 text-lg font-semibold text-gray-600 hover:text-blue-600">
                    ğŸ” í”„ë¡œíŒŒì¼ë§
                </button>
                <button id="analysisTab" class="tab-button flex-1 py-4 px-6 text-lg font-semibold text-gray-600 hover:text-blue-600">
                    ğŸ’¡ ìì—°ì–´ ë¶„ì„
                </button>
                <button id="historyTab" class="tab-button flex-1 py-4 px-6 text-lg font-semibold rounded-tr-xl text-gray-600 hover:text-blue-600">
                    ğŸ“‹ ê¸°ë¡ ì¡°íšŒ
                </button>
            </div>

            <!-- ë°ì´í„° ì„¤ì • íƒ­ -->
            <div id="setupContent" class="tab-content active p-6 md:p-8">
                <div class="space-y-6">
                    <div>
                        <label for="gcpProjectId" class="block text-sm font-medium text-gray-700 mb-2">
                            GCP Project ID <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="gcpProjectId" 
                               class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="my-gcp-project"
                               value="">
                    </div>
                    <div>
                        <label for="tableIds" class="block text-sm font-medium text-gray-700 mb-2">
                            BigQuery Table IDs <span class="text-red-500">*</span>
                            <span class="text-gray-500 font-normal">(ì‰¼í‘œ ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</span>
                        </label>
                        <textarea id="tableIds" rows="4" 
                                  class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                  placeholder="project.dataset.table1,&#10;project.dataset.table2"></textarea>
                        <div class="mt-2 text-xs text-gray-500">
                            ì˜ˆì‹œ: bigquery-public-data.google_ads_transparency_center.creative_stats
                        </div>
                    </div>
                    <div class="flex justify-center">
                        <button id="startProfilingButton" 
                                class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-semibold py-3 px-8 rounded-lg text-lg transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:transform-none">
                            ğŸš€ í”„ë¡œíŒŒì¼ë§ ì‹œì‘í•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>

            <!-- í”„ë¡œíŒŒì¼ë§ íƒ­ -->
            <div id="profilingContent" class="tab-content p-6 md:p-8">
                <!-- ì§„í–‰ ìƒí™© -->
                <div id="progressSection" class="mb-8 hidden">
                    <h2 class="text-2xl font-bold mb-6 text-center text-gray-900">í”„ë¡œíŒŒì¼ë§ ì§„í–‰ ìƒí™©</h2>
                    <div id="statusContainer" class="space-y-4 mb-8"></div>
                    <div class="bg-gray-900 text-green-400 font-mono text-sm rounded-lg p-4 h-48 overflow-y-auto">
                        <div id="liveLogContainer"></div>
                    </div>
                </div>
                
                <!-- í”„ë¡œíŒŒì¼ë§ ê²°ê³¼ -->
                <div id="profilingResults" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-gray-900">ğŸ“Š ë°ì´í„° í”„ë¡œíŒŒì¼ë§ ë¦¬í¬íŠ¸</h2>
                    <div id="profilingReportContent" class="space-y-6"></div>
                </div>
            </div>

            <!-- ìì—°ì–´ ë¶„ì„ íƒ­ -->
            <div id="analysisContent" class="tab-content p-6 md:p-8">
                <div id="analysisSetupSection">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">ğŸ¤– ìì—°ì–´ ì§ˆì˜ ë¶„ì„</h2>
                        <p class="text-gray-600">í”„ë¡œíŒŒì¼ë§ì´ ì™„ë£Œëœ í›„ ìì—°ì–´ë¡œ ë°ì´í„°ë¥¼ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                    
                    <!-- ë¶„ì„ ëª¨ë“œ ì„ íƒ -->
                    <div class="grid md:grid-cols-3 gap-6 mb-8" id="analysisModesSection" style="display: none;">
                        <div class="mode-card bg-white border-2 border-blue-200 rounded-xl p-6 cursor-pointer hover:border-blue-400" data-mode="quick">
                            <div class="text-center">
                                <div class="text-4xl mb-4">âš¡</div>
                                <h3 class="text-xl font-bold text-gray-900 mb-2">ë¹ ë¥¸ ì¡°íšŒ</h3>
                                <p class="text-gray-600 text-sm">ê¸°ë³¸ ë°ì´í„° ì¡°íšŒ ë° SQL ì‹¤í–‰</p>
                            </div>
                        </div>
                        <div class="mode-card bg-white border-2 border-green-200 rounded-xl p-6 cursor-pointer hover:border-green-400" data-mode="analyze">
                            <div class="text-center">
                                <div class="text-4xl mb-4">ğŸ“Š</div>
                                <h3 class="text-xl font-bold text-gray-900 mb-2">êµ¬ì¡°í™”ëœ ë¶„ì„</h3>
                                <p class="text-gray-600 text-sm">ì°¨íŠ¸ + ìƒì„¸ ë¶„ì„ ë¦¬í¬íŠ¸</p>
                            </div>
                        </div>
                        <div class="mode-card bg-white border-2 border-purple-200 rounded-xl p-6 cursor-pointer hover:border-purple-400" data-mode="creative-html">
                            <div class="text-center">
                                <div class="text-4xl mb-4">ğŸ¨</div>
                                <h3 class="text-xl font-bold text-gray-900 mb-2">ì°½ì˜ì  HTML</h3>
                                <p class="text-gray-600 text-sm">ì™„ì „í•œ HTML ë¶„ì„ ë¦¬í¬íŠ¸</p>
                            </div>
                        </div>
                    </div>

                    <!-- ì§ˆë¬¸ ì…ë ¥ ì„¹ì…˜ -->
                    <div id="questionSection" style="display: none;">
                        <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
                            <label for="naturalLanguageQuery" class="block text-sm font-medium text-gray-700 mb-2">
                                ìì—°ì–´ ì§ˆë¬¸ <span class="text-red-500">*</span>
                            </label>
                            <textarea id="naturalLanguageQuery" rows="3" 
                                      class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                      placeholder="ì˜ˆ: ê°€ì¥ ë§ì´ ì‚¬ìš©ë˜ëŠ” ê¸°ê¸° ì¹´í…Œê³ ë¦¬ëŠ” ë¬´ì—‡ì¸ê°€ìš”?"></textarea>
                            <div class="flex justify-between items-center mt-4">
                                <div class="text-sm text-gray-500">
                                    ì„ íƒëœ ëª¨ë“œ: <span id="selectedModeDisplay" class="font-semibold text-blue-600"></span>
                                </div>
                                <button id="executeAnalysisButton" 
                                        class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition-all">
                                    ë¶„ì„ ì‹¤í–‰
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ë¶„ì„ ê²°ê³¼ -->
                <div id="analysisResults" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">ë¶„ì„ ê²°ê³¼</h2>
                        <button id="newAnalysisButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">
                            ìƒˆ ë¶„ì„
                        </button>
                    </div>
                    <div id="analysisResultContent" class="analysis-result"></div>
                </div>
            </div>

            <!-- ê¸°ë¡ ì¡°íšŒ íƒ­ -->
            <div id="historyContent" class="tab-content p-6 md:p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">ğŸ“‹ ì‘ì—… ê¸°ë¡</h2>
                    <button id="refreshHistoryButton" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">
                        ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
                <div id="historyContainer" class="space-y-4">
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-6xl mb-4">ğŸ“</div>
                        <p>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œíŒŒì¼ë§ì„ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- í‘¸í„° -->
        <footer class="text-center text-gray-500 text-sm py-8 border-t border-gray-200">
            <p>Â© 2024 í†µí•© BigQuery ë¶„ì„ê¸°. Claude AI ê¸°ë°˜ ë™ì  ìŠ¤í‚¤ë§ˆ ë¶„ì„ ë„êµ¬.</p>
        </footer>
    </div>

    <!-- JavaScript -->
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentProjectId = '';
        let currentTableIds = [];
        let selectedAnalysisMode = '';
        let profilingCompleted = false;
        let currentSessionId = '';

        // DOM ìš”ì†Œ ì°¸ì¡°
        const elements = {
            // íƒ­ ê´€ë ¨
            setupTab: document.getElementById('setupTab'),
            profilingTab: document.getElementById('profilingTab'),
            analysisTab: document.getElementById('analysisTab'),
            historyTab: document.getElementById('historyTab'),
            
            setupContent: document.getElementById('setupContent'),
            profilingContent: document.getElementById('profilingContent'),
            analysisContent: document.getElementById('analysisContent'),
            historyContent: document.getElementById('historyContent'),
            
            // ì„¤ì • ê´€ë ¨
            gcpProjectId: document.getElementById('gcpProjectId'),
            tableIds: document.getElementById('tableIds'),
            startProfilingButton: document.getElementById('startProfilingButton'),
            
            // í”„ë¡œíŒŒì¼ë§ ê´€ë ¨
            progressSection: document.getElementById('progressSection'),
            statusContainer: document.getElementById('statusContainer'),
            liveLogContainer: document.getElementById('liveLogContainer'),
            profilingResults: document.getElementById('profilingResults'),
            profilingReportContent: document.getElementById('profilingReportContent'),
            
            // ë¶„ì„ ê´€ë ¨
            analysisModesSection: document.getElementById('analysisModesSection'),
            questionSection: document.getElementById('questionSection'),
            naturalLanguageQuery: document.getElementById('naturalLanguageQuery'),
            selectedModeDisplay: document.getElementById('selectedModeDisplay'),
            executeAnalysisButton: document.getElementById('executeAnalysisButton'),
            analysisResults: document.getElementById('analysisResults'),
            analysisResultContent: document.getElementById('analysisResultContent'),
            newAnalysisButton: document.getElementById('newAnalysisButton'),
            
            // ê¸°ë¡ ê´€ë ¨
            refreshHistoryButton: document.getElementById('refreshHistoryButton'),
            historyContainer: document.getElementById('historyContainer')
        };

        // íƒ­ ê´€ë¦¬
        function initializeTabs() {
            const tabButtons = [elements.setupTab, elements.profilingTab, elements.analysisTab, elements.historyTab];
            const tabContents = [elements.setupContent, elements.profilingContent, elements.analysisContent, elements.historyContent];

            tabButtons.forEach((button, index) => {
                button.addEventListener('click', () => {
                    // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
                    tabButtons.forEach(btn => btn.classList.remove('active', 'bg-blue-600', 'text-white'));
                    tabButtons.forEach(btn => btn.classList.add('text-gray-600', 'hover:text-blue-600'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // ì„ íƒëœ íƒ­ í™œì„±í™”
                    button.classList.add('active', 'bg-blue-600', 'text-white');
                    button.classList.remove('text-gray-600', 'hover:text-blue-600');
                    tabContents[index].classList.add('active');
                    
                    // ê¸°ë¡ íƒ­ ì„ íƒ ì‹œ ìë™ ë¡œë“œ
                    if (index === 3) {
                        loadHistory();
                    }
                });
            });
        }

        // ì…ë ¥ ê²€ì¦
        function validateInputs() {
            const projectId = elements.gcpProjectId.value.trim();
            const tables = elements.tableIds.value.trim();
            const isValid = projectId && tables;
            
            elements.startProfilingButton.disabled = !isValid;
            
            if (isValid) {
                elements.startProfilingButton.classList.remove('bg-gray-400');
                elements.startProfilingButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else {
                elements.startProfilingButton.classList.add('bg-gray-400');
                elements.startProfilingButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }
        }

        // í”„ë¡œíŒŒì¼ë§ ìƒíƒœ ì´ˆê¸°í™”
        function initializeProfilingStatus() {
            elements.statusContainer.innerHTML = '';
            elements.liveLogContainer.innerHTML = '';
            
            const steps = [
                { id: 0, text: "ë©”íƒ€ë°ì´í„° ì¶”ì¶œ ì¤€ë¹„" },
                { id: 1, text: "í…Œì´ë¸” ë©”íƒ€ë°ì´í„° ì¶”ì¶œ" },
                { id: 2, text: "í”„ë¡œíŒŒì¼ë§ ë¦¬í¬íŠ¸ ìƒì„±" },
                { id: 3, text: "ê²°ê³¼ ì €ì¥" },
                { id: 4, text: "í”„ë¡œíŒŒì¼ë§ ì™„ë£Œ" }
            ];

            steps.forEach(step => {
                const statusItem = document.createElement('div');
                statusItem.id = `status-${step.id}`;
                statusItem.className = 'status-item flex items-center text-gray-500 p-3 rounded-lg bg-gray-50';
                statusItem.innerHTML = `
                    <span class="icon w-6 h-6 mr-4 flex-shrink-0">â³</span>
                    <span class="font-medium">${step.text}</span>
                `;
                elements.statusContainer.appendChild(statusItem);
            });
        }

        // í”„ë¡œíŒŒì¼ë§ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateProfilingStatus(payload) {
            const { step, message, session_id } = payload;
            
            if (session_id) {
                currentSessionId = session_id;
            }
            
            const itemToUpdate = document.getElementById(`status-${step}`);
            if (!itemToUpdate) return;
            
            const icon = itemToUpdate.querySelector('.icon');
            const text = itemToUpdate.querySelector('span:last-child');
            
            // ì´ì „ ë‹¨ê³„ë“¤ì„ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½
            for (let i = 0; i < step; i++) {
                const prevStepEl = document.getElementById(`status-${i}`);
                if (prevStepEl && !prevStepEl.classList.contains('error')) {
                   prevStepEl.classList.remove('text-gray-500', 'active', 'bg-gray-50');
                   prevStepEl.classList.add('completed', 'text-green-700', 'bg-green-50');
                   prevStepEl.querySelector('.icon').innerHTML = 'âœ…';
                }
            }

            // í˜„ì¬ ë‹¨ê³„ë¥¼ í™œì„± ìƒíƒœë¡œ ë³€ê²½
            itemToUpdate.classList.remove('text-gray-500', 'bg-gray-50');
            itemToUpdate.classList.add('active', 'text-blue-700', 'bg-blue-50');
            text.textContent = message;
            icon.innerHTML = '<svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
        }

        // ë¡œê·¸ ë©”ì‹œì§€ ì¶”ê°€
        function appendLogMessage(payload) {
            const logLine = document.createElement('div');
            logLine.innerHTML = `<span class="text-yellow-400">[${new Date().toLocaleTimeString()}]</span> <span class="text-green-400">${payload.message}</span>`;
            elements.liveLogContainer.appendChild(logLine);
            elements.liveLogContainer.scrollTop = elements.liveLogContainer.scrollHeight;
        }

        // í”„ë¡œíŒŒì¼ë§ ì™„ë£Œ ì²˜ë¦¬
        function handleProfilingComplete() {
            // ëª¨ë“  ë‹¨ê³„ë¥¼ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½
            for (let i = 0; i < 5; i++) {
                const stepEl = document.getElementById(`status-${i}`);
                if (stepEl) {
                    stepEl.classList.remove('active', 'text-blue-700', 'bg-blue-50');
                    stepEl.classList.add('completed', 'text-green-700', 'bg-green-50');
                    stepEl.querySelector('.icon').innerHTML = 'âœ…';
                }
            }
            
            elements.startProfilingButton.disabled = false;
            elements.startProfilingButton.textContent = 'ğŸ”„ ë‹¤ì‹œ í”„ë¡œíŒŒì¼ë§';
            elements.startProfilingButton.classList.remove('bg-gray-400');
            elements.startProfilingButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            
            profilingCompleted = true;
            
            // ë¶„ì„ ëª¨ë“œ ì„¹ì…˜ í™œì„±í™”
            elements.analysisModesSection.style.display = 'grid';
            
            // ë¶„ì„ íƒ­ìœ¼ë¡œ ìë™ ì´ë™ (ì„ íƒì‚¬í•­)
            setTimeout(() => {
                elements.analysisTab.click();
            }, 2000);
        }

        // í”„ë¡œíŒŒì¼ë§ ë¦¬í¬íŠ¸ ì„¹ì…˜ ì¶”ê°€
        function addProfilingReportSection(sectionData) {
            const { section, title, content } = sectionData;
            
            const sectionElement = document.createElement('div');
            sectionElement.id = `section-${section}`;
            sectionElement.className = 'mb-6 border border-gray-200 rounded-lg overflow-hidden';
            
            const icons = {
                'overview': 'ğŸ“‹',
                'table_analysis': 'ğŸ“Š',
                'relationships': 'ğŸ”—',
                'business_questions': 'â“',
                'recommendations': 'ğŸ’¡'
            };
            
            sectionElement.innerHTML = `
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center">
                        <span class="text-2xl mr-3">${icons[section] || 'ğŸ“„'}</span>${title}
                    </h3>
                </div>
                <div class="p-6 bg-white">
                    <div class="prose max-w-none">${marked.parse(content)}</div>
                </div>
            `;
            
            elements.profilingReportContent.appendChild(sectionElement);
            
            // í”„ë¡œíŒŒì¼ë§ ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
            elements.profilingResults.classList.remove('hidden');
            
            sectionElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // í”„ë¡œíŒŒì¼ë§ ì‹œì‘
        function startProfiling() {
            currentProjectId = elements.gcpProjectId.value.trim();
            const tablesInput = elements.tableIds.value.trim();
            currentTableIds = tablesInput.split(/[,\n]+/).map(s => s.trim()).filter(Boolean);
            
            if (!currentProjectId || currentTableIds.length === 0) {
                alert('Project IDì™€ Table IDsë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // UI ìƒíƒœ ë³€ê²½
            elements.startProfilingButton.disabled = true;
            elements.startProfilingButton.textContent = 'â³ í”„ë¡œíŒŒì¼ë§ ì§„í–‰ ì¤‘...';
            elements.startProfilingButton.classList.add('bg-gray-400');
            
            // í”„ë¡œíŒŒì¼ë§ íƒ­ìœ¼ë¡œ ì´ë™
            elements.profilingTab.click();
            
            // ìƒíƒœ ì´ˆê¸°í™” ë° í‘œì‹œ
            initializeProfilingStatus();
            elements.progressSection.classList.remove('hidden');
            elements.profilingResults.classList.add('hidden');
            elements.profilingReportContent.innerHTML = '';
            
            // SSE ì—°ê²°
            const eventSourceUrl = `/profiling?projectId=${encodeURIComponent(currentProjectId)}&tableIds=${encodeURIComponent(currentTableIds.join(','))}`;
            const eventSource = new EventSource(eventSourceUrl);
            
            eventSource.onmessage = function (event) {
                const eventData = JSON.parse(event.data);
                
                switch (eventData.type) {
                    case 'status':
                        updateProfilingStatus(eventData.payload);
                        break;
                    case 'log':
                        appendLogMessage(eventData.payload);
                        break;
                    case 'report_section':
                        addProfilingReportSection(eventData.payload);
                        break;
                    case 'profiling_complete':
                        handleProfilingComplete();
                        eventSource.close();
                        break;
                    case 'error':
                        appendLogMessage({ message: `âŒ ì˜¤ë¥˜: ${eventData.payload.message}` });
                        handleProfilingError(eventData.payload.message);
                        eventSource.close();
                        break;
                }
            };

            eventSource.onerror = function(err) {
                console.error("EventSource failed:", err);
                appendLogMessage({ message: "âŒ ì„œë²„ ì—°ê²° ì˜¤ë¥˜ ë°œìƒ." });
                handleProfilingError("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                eventSource.close();
            };
        }

        // í”„ë¡œíŒŒì¼ë§ ì˜¤ë¥˜ ì²˜ë¦¬
        function handleProfilingError(message) {
            const errorStep = document.getElementById('status-0');
            if (errorStep) {
                errorStep.classList.add('error', 'text-red-700', 'bg-red-50');
                errorStep.querySelector('.icon').innerHTML = 'âŒ';
                errorStep.querySelector('span:last-child').textContent = message || 'ì˜¤ë¥˜ ë°œìƒ';
            }
            
            elements.startProfilingButton.disabled = false;
            elements.startProfilingButton.textContent = 'ğŸ”„ ë‹¤ì‹œ ì‹œë„';
            elements.startProfilingButton.classList.remove('bg-gray-400');
            elements.startProfilingButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }

        // ë¶„ì„ ëª¨ë“œ ì„ íƒ
        function initializeAnalysisModes() {
            const modeCards = document.querySelectorAll('.mode-card');
            
            modeCards.forEach(card => {
                card.addEventListener('click', () => {
                    // ëª¨ë“  ì¹´ë“œ ë¹„í™œì„±í™”
                    modeCards.forEach(c => {
                        c.classList.remove('border-blue-500', 'border-green-500', 'border-purple-500', 'bg-blue-50', 'bg-green-50', 'bg-purple-50');
                        c.classList.add('border-gray-200');
                    });
                    
                    // ì„ íƒëœ ì¹´ë“œ í™œì„±í™”
                    const mode = card.dataset.mode;
                    selectedAnalysisMode = mode;
                    
                    if (mode === 'quick') {
                        card.classList.remove('border-gray-200');
                        card.classList.add('border-blue-500', 'bg-blue-50');
                        elements.selectedModeDisplay.textContent = 'ë¹ ë¥¸ ì¡°íšŒ';
                    } else if (mode === 'analyze') {
                        card.classList.remove('border-gray-200');
                        card.classList.add('border-green-500', 'bg-green-50');
                        elements.selectedModeDisplay.textContent = 'êµ¬ì¡°í™”ëœ ë¶„ì„';
                    } else if (mode === 'creative-html') {
                        card.classList.remove('border-gray-200');
                        card.classList.add('border-purple-500', 'bg-purple-50');
                        elements.selectedModeDisplay.textContent = 'ì°½ì˜ì  HTML';
                    }
                    
                    // ì§ˆë¬¸ ì„¹ì…˜ í‘œì‹œ
                    elements.questionSection.style.display = 'block';
                });
            });
        }

        // ìì—°ì–´ ë¶„ì„ ì‹¤í–‰
        async function executeAnalysis() {
            const question = elements.naturalLanguageQuery.value.trim();
            
            if (!question) {
                alert('ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!selectedAnalysisMode) {
                alert('ë¶„ì„ ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!profilingCompleted) {
                alert('ë¨¼ì € í”„ë¡œíŒŒì¼ë§ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // UI ìƒíƒœ ë³€ê²½
            elements.executeAnalysisButton.disabled = true;
            elements.executeAnalysisButton.textContent = 'ë¶„ì„ ì¤‘...';
            
            try {
                const requestData = {
                    question: question,
                    project_id: currentProjectId,
                    table_ids: currentTableIds
                };
                
                const response = await fetch(`/${selectedAnalysisMode}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayAnalysisResult(result);
                } else {
                    throw new Error(result.error || 'ë¶„ì„ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('Analysis error:', error);
                alert(`ë¶„ì„ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: ${error.message}`);
            } finally {
                elements.executeAnalysisButton.disabled = false;
                elements.executeAnalysisButton.textContent = 'ë¶„ì„ ì‹¤í–‰';
            }
        }

        // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        function displayAnalysisResult(result) {
            elements.analysisResults.classList.remove('hidden');
            
            let resultHTML = '';
            
            if (result.mode === 'quick') {
                resultHTML = generateQuickResultHTML(result);
            } else if (result.mode === 'structured') {
                resultHTML = generateStructuredResultHTML(result);
            } else if (result.mode === 'creative_html') {
                resultHTML = generateCreativeHTMLResult(result);
            }
            
            elements.analysisResultContent.innerHTML = resultHTML;
            elements.analysisResultContent.scrollIntoView({ behavior: 'smooth' });
        }

        // ë¹ ë¥¸ ì¡°íšŒ ê²°ê³¼ HTML ìƒì„±
        function generateQuickResultHTML(result) {
            const { original_question, generated_sql, data, row_count } = result;
            
            let tableHTML = '';
            if (data && data.length > 0) {
                const columns = Object.keys(data[0]);
                const headerHTML = columns.map(col => `<th class="px-4 py-2 bg-blue-500 text-white">${col}</th>`).join('');
                const rowsHTML = data.slice(0, 20).map(row => 
                    `<tr>${columns.map(col => `<td class="px-4 py-2 border">${row[col] || ''}</td>`).join('')}</tr>`
                ).join('');
                
                tableHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full border-collapse border border-gray-300">
                            <thead><tr>${headerHTML}</tr></thead>
                            <tbody>${rowsHTML}</tbody>
                        </table>
                    </div>
                `;
            }
            
            return `
                <div class="bg-white rounded-lg border border-gray-200 p-6 space-y-6">
                    <div class="border-b pb-4">
                        <h3 class="text-xl font-bold text-gray-900 mb-2">âš¡ ë¹ ë¥¸ ì¡°íšŒ ê²°ê³¼</h3>
                        <p class="text-gray-600"><strong>ì§ˆë¬¸:</strong> ${original_question}</p>
                        <p class="text-gray-600"><strong>ê²°ê³¼:</strong> ${row_count}ê°œ í–‰</p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">ğŸ” ìƒì„±ëœ SQL</h4>
                        <pre class="bg-gray-100 p-4 rounded-lg overflow-x-auto"><code>${generated_sql}</code></pre>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">ğŸ“Š ë°ì´í„° (ìƒìœ„ 20ê°œ)</h4>
                        ${tableHTML || '<p class="text-gray-500">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'}
                    </div>
                </div>
            `;
        }

        // êµ¬ì¡°í™”ëœ ë¶„ì„ ê²°ê³¼ HTML ìƒì„±
        function generateStructuredResultHTML(result) {
            const { original_question, generated_sql, data, row_count, analysis_report, chart_config } = result;
            
            let chartHTML = '';
            if (chart_config && data && data.length > 0) {
                chartHTML = `
                    <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
                        <h4 class="font-semibold text-gray-800 mb-4">ğŸ“ˆ ì‹œê°í™”</h4>
                        <div class="chart-container">
                            <canvas id="analysisChart"></canvas>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="space-y-6">
                    <div class="bg-white rounded-lg border border-gray-200 p-6">
                        <h3 class="text-xl font-bold text-gray-900 mb-2">ğŸ“Š êµ¬ì¡°í™”ëœ ë¶„ì„ ê²°ê³¼</h3>
                        <p class="text-gray-600"><strong>ì§ˆë¬¸:</strong> ${original_question}</p>
                        <p class="text-gray-600"><strong>ê²°ê³¼:</strong> ${row_count}ê°œ í–‰</p>
                    </div>
                    
                    ${chartHTML}
                    
                    <div class="bg-white rounded-lg border border-gray-200 p-6">
                        <h4 class="font-semibold text-gray-800 mb-4">ğŸ“‹ ë¶„ì„ ë¦¬í¬íŠ¸</h4>
                        <div class="prose max-w-none">${marked.parse(analysis_report || 'ë¶„ì„ ë¦¬í¬íŠ¸ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')}</div>
                    </div>
                    
                    <div class="bg-white rounded-lg border border-gray-200 p-6">
                        <h4 class="font-semibold text-gray-800 mb-2">ğŸ” ìƒì„±ëœ SQL</h4>
                        <pre class="bg-gray-100 p-4 rounded-lg overflow-x-auto"><code>${generated_sql}</code></pre>
                    </div>
                </div>
            `;
        }

        // ì°½ì˜ì  HTML ê²°ê³¼ ì²˜ë¦¬
        function generateCreativeHTMLResult(result) {
            const { original_question, html_content, quality_score, is_fallback } = result;
            
            return `
                <div class="bg-white rounded-lg border border-gray-200 p-6 space-y-6">
                    <div class="border-b pb-4">
                        <h3 class="text-xl font-bold text-gray-900 mb-2">ğŸ¨ ì°½ì˜ì  HTML ë¦¬í¬íŠ¸</h3>
                        <p class="text-gray-600"><strong>ì§ˆë¬¸:</strong> ${original_question}</p>
                        <p class="text-gray-600"><strong>í’ˆì§ˆ ì ìˆ˜:</strong> ${quality_score}/100 ${is_fallback ? '(í´ë°± ëª¨ë“œ)' : ''}</p>
                    </div>
                    
                    <div class="border rounded-lg overflow-hidden">
                        <div class="bg-gray-100 px-4 py-2 text-sm text-gray-600 border-b">
                            ìƒì„±ëœ HTML ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸°
                        </div>
                        <iframe srcdoc="${html_content.replace(/"/g, '&quot;')}" 
                                class="w-full h-96 border-0"></iframe>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button onclick="downloadHTML('${original_question}', \`${html_content.replace(/`/g, '\\`')}\`)" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            ğŸ“¥ HTML ë‹¤ìš´ë¡œë“œ
                        </button>
                        <button onclick="openHTMLInNewTab(\`${html_content.replace(/`/g, '\\`')}\`)" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                            ğŸš€ ìƒˆ íƒ­ì—ì„œ ì—´ê¸°
                        </button>
                    </div>
                </div>
            `;
        }

        // ê¸°ë¡ ë¡œë“œ
        async function loadHistory() {
            try {
                const response = await fetch('/logs');
                const logs = await response.json();
                
                if (!Array.isArray(logs) || logs.length === 0) {
                    elements.historyContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-6xl mb-4">ğŸ“</div>
                            <p>ì €ì¥ëœ ì‘ì—… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            <p class="text-sm mt-2">í”„ë¡œíŒŒì¼ë§ì„ ì‹¤í–‰í•˜ë©´ ê¸°ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>
                    `;
                    return;
                }
                
                const historyHTML = logs.map(log => generateHistoryItemHTML(log)).join('');
                elements.historyContainer.innerHTML = historyHTML;
                
            } catch (error) {
                console.error('History loading error:', error);
                elements.historyContainer.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <div class="text-6xl mb-4">âŒ</div>
                        <p>ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            }
        }

        // ê¸°ë¡ í•­ëª© HTML ìƒì„±
        function generateHistoryItemHTML(log) {
            const statusColor = log.status === 'ì™„ë£Œ' ? 'text-green-600 bg-green-50' : 
                              (log.status === 'ì‹¤íŒ¨' ? 'text-red-600 bg-red-50' : 'text-yellow-600 bg-yellow-50');
            const statusIcon = log.status === 'ì™„ë£Œ' ? 'âœ…' : (log.status === 'ì‹¤íŒ¨' ? 'âŒ' : 'â³');
            
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${statusIcon}</span>
                            <div>
                                <span class="font-semibold ${statusColor} px-3 py-1 rounded-full text-sm">${log.status}</span>
                                <p class="text-gray-600 mt-1">${new Date(log.start_time).toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="text-right text-sm text-gray-500">
                            <p><strong>í”„ë¡œì íŠ¸:</strong> ${log.project_id}</p>
                            <p><strong>í…Œì´ë¸”:</strong> ${(log.table_ids || []).length}ê°œ</p>
                        </div>
                    </div>
                    
                    <div class="text-sm text-gray-600">
                        <p><strong>í…Œì´ë¸” ëª©ë¡:</strong> ${(log.table_ids || []).join(', ')}</p>
                        ${log.error_message ? `<p class="text-red-600 mt-2"><strong>ì˜¤ë¥˜:</strong> ${log.error_message}</p>` : ''}
                    </div>
                </div>
            `;
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function downloadHTML(title, content) {
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title.replace(/[^a-zA-Z0-9]/g, '_')}_report.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function openHTMLInNewTab(content) {
            const newWindow = window.open();
            newWindow.document.write(content);
            newWindow.document.close();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // ê°„ë‹¨í•œ ì•Œë¦¼ í‘œì‹œ
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                notification.textContent = 'í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.';
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 2000);
            });
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        function initializeEventListeners() {
            // ì…ë ¥ ê²€ì¦
            elements.gcpProjectId.addEventListener('input', validateInputs);
            elements.tableIds.addEventListener('input', validateInputs);
            
            // í”„ë¡œíŒŒì¼ë§ ì‹œì‘
            elements.startProfilingButton.addEventListener('click', startProfiling);
            
            // ë¶„ì„ ì‹¤í–‰
            elements.executeAnalysisButton.addEventListener('click', executeAnalysis);
            
            // ìƒˆ ë¶„ì„ ë²„íŠ¼
            elements.newAnalysisButton.addEventListener('click', () => {
                elements.analysisResults.classList.add('hidden');
                elements.naturalLanguageQuery.value = '';
                selectedAnalysisMode = '';
                elements.selectedModeDisplay.textContent = '';
                elements.questionSection.style.display = 'none';
                
                // ëª¨ë“  ëª¨ë“œ ì¹´ë“œ ë¹„í™œì„±í™”
                document.querySelectorAll('.mode-card').forEach(card => {
                    card.classList.remove('border-blue-500', 'border-green-500', 'border-purple-500', 'bg-blue-50', 'bg-green-50', 'bg-purple-50');
                    card.classList.add('border-gray-200');
                });
            });
            
            // ê¸°ë¡ ìƒˆë¡œê³ ì¹¨
            elements.refreshHistoryButton.addEventListener('click', loadHistory);
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function () {
            initializeTabs();
            initializeAnalysisModes();
            initializeEventListeners();
            validateInputs();
            
            console.log('í†µí•© BigQuery ë¶„ì„ê¸° ì´ˆê¸°í™” ì™„ë£Œ');
        });
    </script>
</body>
</html>