{% extends "layout.html" %}

{% block title %}채팅 - BigQuery AI Assistant{% endblock %}

{% block content %}
<div class="w-full h-full flex flex-col">
    <!-- 상단 헤더 -->
    <header class="p-4 border-b border-gray-200 bg-white flex justify-between items-center">
        <h2 class="text-lg font-semibold text-gray-800">분석 채팅</h2>
        <div class="flex items-center space-x-4">
            <div id="profilingStatusWrapper" class="flex items-center text-sm text-gray-600">
                <span class="status-indicator status-inactive" id="profiling-status-indicator"></span>
                <span id="profilingStatus">대기 중</span>
            </div>
            <button id="startProfilingButton" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg text-sm transition-colors disabled:bg-gray-400"
                    disabled>
                프로파일링 시작
            </button>
        </div>
    </header>

    <!-- 메시지 영역 -->
    <div class="messages-area flex-1 bg-gray-50" id="messagesArea">
        <!-- 초기 메시지가 여기에 표시됩니다 -->
    </div>

    <!-- 입력 영역 -->
    <div class="input-area">
        <div class="relative flex items-center">
            <textarea id="chatInput" 
                      class="w-full border border-gray-300 rounded-lg py-2 pl-4 pr-24 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" 
                      placeholder="데이터에 대해 질문해보세요..." 
                      rows="1" 
                      disabled></textarea>
            <button id="sendButton" class="absolute right-2 bg-blue-600 text-white rounded-md p-2 disabled:bg-gray-400" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                </svg>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentSettings = { projectId: null, tableIds: [] };
    let profilingCompleted = false;

    const elements = {
        startProfilingButton: document.getElementById('startProfilingButton'),
        profilingStatusIndicator: document.getElementById('profiling-status-indicator'),
        profilingStatus: document.getElementById('profilingStatus'),
        messagesArea: document.getElementById('messagesArea'),
        chatInput: document.getElementById('chatInput'),
        sendButton: document.getElementById('sendButton'),
        selectedTablesNavList: document.getElementById('selected-tables-nav-list'),
    };

    function updateSelectedTablesNav() {
        if (!elements.selectedTablesNavList) return;
        elements.selectedTablesNavList.innerHTML = '';

        if (!currentSettings.tableIds || currentSettings.tableIds.length === 0) {
            elements.selectedTablesNavList.innerHTML = '<li class="px-3 py-1 text-sm text-gray-400">테이블이 선택되지 않았습니다.</li>';
        } else {
            currentSettings.tableIds.forEach(tableId => {
                const li = document.createElement('li');
                li.className = 'px-3 py-1 text-sm text-gray-700 truncate';
                li.textContent = tableId.split('.').pop();
                li.title = tableId;
                elements.selectedTablesNavList.appendChild(li);
            });
        }
    }

    function loadSettings() {
        const savedSettings = localStorage.getItem('bigqueryAISettings');
        if (savedSettings) {
            currentSettings = JSON.parse(savedSettings);
            if (currentSettings.projectId && currentSettings.tableIds.length > 0) {
                elements.startProfilingButton.disabled = false;
                showWelcomeMessage();
                updateSelectedTablesNav();
                return;
            }
        }
        elements.startProfilingButton.disabled = true;
        showSettingsNeededMessage();
        updateSelectedTablesNav();
    }

    function showWelcomeMessage() {
        elements.messagesArea.innerHTML = `
            <div class="flex justify-center items-center h-full">
                <div class="text-center max-w-md">
                    <div class="text-6xl mb-4">🤖</div>
                    <h2 class="text-2xl font-semibold text-gray-900 mb-2">BigQuery AI Assistant</h2>
                    <p class="text-gray-600 mb-6">'프로파일링 시작' 버튼을 눌러 데이터 분석을 시작하세요.</p>
                </div>
            </div>`;
    }
    
    function showSettingsNeededMessage() {
         elements.messagesArea.innerHTML = `
            <div class="flex justify-center items-center h-full">
                <div class="text-center max-w-md">
                    <div class="text-6xl mb-4">⚙️</div>
                    <h2 class="text-2xl font-semibold text-gray-900 mb-2">설정이 필요합니다</h2>
                    <p class="text-gray-600 mb-6">좌측 메뉴의 <a href="/settings" class="text-blue-600 font-semibold">프로젝트 설정</a>으로 이동하여 분석할 대상을 먼저 선택해주세요.</p>
                </div>
            </div>`;
    }
    
    function startProfiling() {
        if (!currentSettings.projectId || currentSettings.tableIds.length === 0) {
            alert('설정이 올바르지 않습니다. 설정 페이지를 확인해주세요.');
            return;
        }

        elements.startProfilingButton.disabled = true;
        elements.startProfilingButton.textContent = '프로파일링 중...';
        elements.profilingStatusIndicator.className = 'status-indicator status-working';
        elements.profilingStatus.textContent = '시작 중...';

        const tableIdsParam = currentSettings.tableIds.join(',');
        const source = new EventSource(`/profiling?projectId=${encodeURIComponent(currentSettings.projectId)}&tableIds=${encodeURIComponent(tableIdsParam)}`);

        source.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            if (data.type === 'status') {
                elements.profilingStatus.textContent = data.payload.message;
            } else if (data.type === 'profiling_complete') {
                profilingCompleted = true;
                elements.profilingStatusIndicator.className = 'status-indicator status-ready';
                elements.profilingStatus.textContent = '완료';
                elements.chatInput.disabled = false;
                elements.sendButton.disabled = false;
                elements.startProfilingButton.textContent = '다시 시작';
                elements.startProfilingButton.disabled = false;
                addMessage(data.payload.report.full_report, false, 'markdown');
                source.close();
            } else if (data.type === 'error') {
                elements.profilingStatusIndicator.className = 'status-indicator status-error';
                elements.profilingStatus.textContent = '오류';
                addMessage(`**프로파일링 오류**\n\n${data.payload.message}`, false, 'markdown');
                source.close();
                elements.startProfilingButton.disabled = false;
                elements.startProfilingButton.textContent = '다시 시작';
            }
        };

        source.onerror = function(err) {
            elements.profilingStatusIndicator.className = 'status-indicator status-error';
            elements.profilingStatus.textContent = '연결 오류';
            source.close();
            elements.startProfilingButton.disabled = false;
            elements.startProfilingButton.textContent = '다시 시작';
        };
    }
    
    let isFirstMessage = true;
    function addMessage(content, isUser = false, type = 'text') {
        if (isFirstMessage) {
            elements.messagesArea.innerHTML = '';
            isFirstMessage = false;
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message-bubble p-4 ${isUser ? 'user-message' : 'ai-message'}`;
        
        if (type === 'markdown') {
            messageDiv.innerHTML = marked.parse(content);
        } else {
            messageDiv.textContent = content;
        }
        
        elements.messagesArea.appendChild(messageDiv);
        elements.messagesArea.scrollTop = elements.messagesArea.scrollHeight;
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadSettings();
        elements.startProfilingButton.addEventListener('click', startProfiling);
    });
</script>
{% endblock %}
