<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BigQuery AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }
        .sidebar {
            width: 320px;
            min-width: 320px;
            max-width: 320px;
        }
        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .input-area {
            border-top: 1px solid #e5e7eb;
            padding: 20px;
            background: white;
        }
        .message-bubble {
            max-width: 80%;
            margin-bottom: 16px;
            word-wrap: break-word;
        }
        .user-message {
            margin-left: auto;
            background: #f3f4f6;
            border-radius: 18px 18px 4px 18px;
        }
        .ai-message {
            margin-right: auto;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 18px 18px 18px 4px;
        }
        .sidebar-section {
            border-bottom: 1px solid #e5e7eb;
        }
        .sidebar-section:last-child {
            border-bottom: none;
        }
        .section-header {
            padding: 16px 20px;
            font-weight: 600;
            color: #374151;
            cursor: pointer;
            user-select: none;
        }
        .section-header:hover {
            background: #f9fafb;
        }
        .section-content {
            padding: 0 20px 20px 20px;
            display: none;
        }
        .section-content.active {
            display: block;
        }
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: flex-end;
            gap: 12px;
        }
        .chat-input {
            flex: 1;
            border: 1px solid #d1d5db;
            border-radius: 24px;
            padding: 12px 20px;
            resize: none;
            font-size: 16px;
            line-height: 1.5;
            max-height: 120px;
            outline: none;
            transition: border-color 0.2s;
        }
        .chat-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .send-button {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        .send-button:hover {
            background: #2563eb;
        }
        .send-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ready { background: #10b981; }
        .status-working { background: #f59e0b; }
        .status-error { background: #ef4444; }
        .status-inactive { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- ì‚¬ì´ë“œë°” -->
        <div class="sidebar bg-white border-r border-gray-200 flex flex-col">
            <!-- í—¤ë” -->
            <div class="p-6 border-b border-gray-200">
                <h1 class="text-xl font-semibold text-gray-900">BigQuery AI</h1>
                <p class="text-sm text-gray-500 mt-1">ë°ì´í„° ë¶„ì„ ë„ìš°ë¯¸</p>
            </div>

            <!-- ì‚¬ì´ë“œë°” ì»¨í…ì¸  -->
            <div class="flex-1 overflow-y-auto">
                <!-- í”„ë¡œì íŠ¸ ì„¤ì • ì„¹ì…˜ -->
                <div class="sidebar-section">
                    <div class="section-header" onclick="toggleSection('project-settings')">
                        <span class="status-indicator status-inactive" id="project-status"></span>
                        í”„ë¡œì íŠ¸ ì„¤ì •
                    </div>
                    <div class="section-content active" id="project-settings">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    GCP Project
                                    <button id="refreshProjectsButton" 
                                            class="ml-2 text-xs text-blue-600 hover:text-blue-700"
                                            onclick="loadGcpProjects()">
                                        ğŸ”„ ìƒˆë¡œê³ ì¹¨
                                    </button>
                                </label>
                                <select id="gcpProjectId" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”...</option>
                                </select>
                                <div id="projectLoadingStatus" class="mt-1 text-xs text-gray-500 hidden">
                                    í”„ë¡œì íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    BigQuery Tables
                                    <button id="refreshTablesButton" 
                                            class="ml-2 text-xs text-blue-600 hover:text-blue-700 disabled:text-gray-400"
                                            onclick="loadProjectTables()"
                                            disabled>
                                        ğŸ”„ ìƒˆë¡œê³ ì¹¨
                                    </button>
                                </label>
                                <div id="tablesContainer" class="border border-gray-300 rounded-lg max-h-40 overflow-y-auto">
                                    <div id="tablesPlaceholder" class="p-3 text-sm text-gray-500 text-center">
                                        ë¨¼ì € í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”
                                    </div>
                                    <div id="tablesLoadingStatus" class="p-3 text-xs text-blue-600 text-center hidden">
                                        <div class="flex items-center justify-center gap-2">
                                            <div class="animate-spin w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                                            í…Œì´ë¸” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                                        </div>
                                    </div>
                                    <div id="tablesList" class="hidden"></div>
                                </div>
                                <div class="mt-2 text-xs text-gray-500">
                                    <span id="tableSelectionStatus">ì„ íƒëœ í…Œì´ë¸”: 0ê°œ</span>
                                    <button id="selectAllTablesButton" 
                                            class="ml-4 text-blue-600 hover:text-blue-700 disabled:text-gray-400"
                                            onclick="toggleAllTables()"
                                            disabled>
                                        ì „ì²´ ì„ íƒ/í•´ì œ
                                    </button>
                                </div>
                            </div>
                            <button id="startProfilingButton" 
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg text-sm transition-colors disabled:bg-gray-400">
                                í”„ë¡œíŒŒì¼ë§ ì‹œì‘
                            </button>
                        </div>
                    </div>
                </div>

                <!-- í”„ë¡œíŒŒì¼ë§ ì„¹ì…˜ -->
                <div class="sidebar-section">
                    <div class="section-header" onclick="toggleSection('profiling-status')">
                        <span class="status-indicator status-inactive" id="profiling-status"></span>
                        í”„ë¡œíŒŒì¼ë§ ìƒíƒœ
                    </div>
                    <div class="section-content" id="profiling-status">
                        <div id="profilingProgress" class="hidden">
                            <div class="space-y-2 mb-4">
                                <div id="statusSteps"></div>
                            </div>
                            <div class="text-xs text-gray-500">
                                <div id="currentStep">ëŒ€ê¸° ì¤‘...</div>
                            </div>
                        </div>
                        <div id="profilingIdle" class="text-sm text-gray-500">
                            í”„ë¡œíŒŒì¼ë§ì„ ì‹œì‘í•˜ë©´ ì§„í–‰ ìƒí™©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>

                <!-- ëŒ€í™” ê¸°ë¡ ì„¹ì…˜ -->  
                <div class="sidebar-section">
                    <div class="section-header" onclick="toggleSection('chat-history')">
                        <span class="status-indicator status-inactive"></span>
                        ëŒ€í™” ê¸°ë¡
                    </div>
                    <div class="section-content" id="chat-history">
                        <div id="historyList" class="space-y-2">
                            <div class="text-sm text-gray-500">
                                ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
                            </div>
                        </div>
                        <button id="refreshHistoryButton" 
                                class="w-full mt-4 text-sm text-blue-600 hover:text-blue-700 font-medium">
                            ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
        <div class="flex-1 chat-container">
            <!-- ë©”ì‹œì§€ ì˜ì—­ -->
            <div class="messages-area" id="messagesArea">
                <!-- ì´ˆê¸° í™˜ì˜ ë©”ì‹œì§€ -->
                <div class="flex justify-center items-center h-full">
                    <div class="text-center max-w-md">
                        <div class="text-6xl mb-4">ğŸ¤–</div>
                        <h2 class="text-2xl font-semibold text-gray-900 mb-2">BigQuery AI Assistant</h2>
                        <p class="text-gray-600 mb-6">ë°ì´í„° í”„ë¡œíŒŒì¼ë§ì„ ì™„ë£Œí•œ í›„ ìì—°ì–´ë¡œ ì§ˆë¬¸í•´ë³´ì„¸ìš”.</p>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-left">
                            <h3 class="font-medium text-blue-900 mb-2">ì‹œì‘í•˜ê¸°:</h3>
                            <ol class="text-sm text-blue-800 space-y-1">
                                <li>1. ì¢Œì¸¡ì—ì„œ GCP í”„ë¡œì íŠ¸ì™€ í…Œì´ë¸” ID ì…ë ¥</li>
                                <li>2. í”„ë¡œíŒŒì¼ë§ ì‹œì‘ ë²„íŠ¼ í´ë¦­</li>
                                <li>3. ì™„ë£Œ í›„ ì•„ë˜ ì…ë ¥ì°½ì—ì„œ ì§ˆë¬¸í•˜ê¸°</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì…ë ¥ ì˜ì—­ -->
            <div class="input-area">
                <div class="input-wrapper">
                    <textarea id="chatInput" 
                              class="chat-input" 
                              placeholder="ë°ì´í„°ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”... (ì˜ˆ: ê°€ì¥ ë§ì´ ì‚¬ìš©ë˜ëŠ” ê¸°ê¸°ëŠ”?)"
                              rows="1"
                              disabled></textarea>
                    <button id="sendButton" class="send-button" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22,2 15,22 11,13 2,9"></polygon>
                        </svg>
                    </button>
                </div>
                <div class="flex justify-between items-center mt-2 text-xs text-gray-500">
                    <div id="inputStatus">í”„ë¡œíŒŒì¼ë§ ì™„ë£Œ í›„ ì§ˆë¬¸ ê°€ëŠ¥</div>
                    <div class="flex gap-4">
                        <button class="text-blue-600 hover:text-blue-700" onclick="selectAnalysisMode('quick')">
                            ë¹ ë¥¸ ì¡°íšŒ
                        </button>
                        <button class="text-green-600 hover:text-green-700" onclick="selectAnalysisMode('analyze')">
                            ìƒì„¸ ë¶„ì„
                        </button>
                        <button class="text-purple-600 hover:text-purple-700" onclick="selectAnalysisMode('creative-html')">
                            HTML ë¦¬í¬íŠ¸
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentProjectId = '';
        let currentTableIds = [];
        let profilingCompleted = false;
        let selectedAnalysisMode = 'analyze'; // ê¸°ë³¸ê°’
        let messageHistory = [];
        let projectTables = [];
        let selectedTables = new Set();

        // DOM ìš”ì†Œ ì°¸ì¡°
        const elements = {
            gcpProjectId: document.getElementById('gcpProjectId'),
            startProfilingButton: document.getElementById('startProfilingButton'),
            projectStatus: document.getElementById('project-status'),
            profilingStatus: document.getElementById('profiling-status'),
            profilingProgress: document.getElementById('profilingProgress'),
            profilingIdle: document.getElementById('profilingIdle'),
            statusSteps: document.getElementById('statusSteps'),
            currentStep: document.getElementById('currentStep'),
            messagesArea: document.getElementById('messagesArea'),
            chatInput: document.getElementById('chatInput'),
            sendButton: document.getElementById('sendButton'),
            inputStatus: document.getElementById('inputStatus'),
            historyList: document.getElementById('historyList'),
            refreshHistoryButton: document.getElementById('refreshHistoryButton'),
            projectLoadingStatus: document.getElementById('projectLoadingStatus'),
            refreshProjectsButton: document.getElementById('refreshProjectsButton'),
            tablesContainer: document.getElementById('tablesContainer'),
            tablesPlaceholder: document.getElementById('tablesPlaceholder'),
            tablesLoadingStatus: document.getElementById('tablesLoadingStatus'),
            tablesList: document.getElementById('tablesList'),
            tableSelectionStatus: document.getElementById('tableSelectionStatus'),
            refreshTablesButton: document.getElementById('refreshTablesButton'),
            selectAllTablesButton: document.getElementById('selectAllTablesButton')
        };

        // GCP í”„ë¡œì íŠ¸ ëª©ë¡ ë¡œë“œ
        async function loadGcpProjects() {
            elements.projectLoadingStatus.classList.remove('hidden');
            elements.projectLoadingStatus.textContent = 'í”„ë¡œì íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            elements.refreshProjectsButton.disabled = true;
            
            try {
                const response = await fetch('/api/gcp-projects');
                const result = await response.json();
                
                if (result.success) {
                    populateProjectDropdown(result.projects);
                    elements.projectLoadingStatus.textContent = `${result.count}ê°œ í”„ë¡œì íŠ¸ ë¡œë“œ ì™„ë£Œ`;
                    
                    // í˜„ì¬ ê¸°ë³¸ í”„ë¡œì íŠ¸ ì„ íƒ
                    await selectCurrentProject();
                } else {
                    throw new Error(result.error || 'í”„ë¡œì íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('GCP í”„ë¡œì íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
                elements.projectLoadingStatus.textContent = `ì˜¤ë¥˜: ${error.message}`;
                elements.projectLoadingStatus.classList.add('text-red-500');
                
                // ì˜¤ë¥˜ ì‹œ ìˆ˜ë™ ì…ë ¥ ì˜µì…˜ ì œê³µ
                populateProjectDropdown([]);
                addManualInputOption();
            } finally {
                elements.refreshProjectsButton.disabled = false;
                setTimeout(() => {
                    elements.projectLoadingStatus.classList.add('hidden');
                    elements.projectLoadingStatus.classList.remove('text-red-500');
                }, 3000);
            }
        }

        // í”„ë¡œì íŠ¸ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
        function populateProjectDropdown(projects) {
            const select = elements.gcpProjectId;
            
            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ ì˜µì…˜ ì œì™¸)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            if (projects.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                option.disabled = true;
                select.appendChild(option);
                return;
            }
            
            // í”„ë¡œì íŠ¸ ì˜µì…˜ ì¶”ê°€
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.project_id;
                option.textContent = `${project.display_name} (${project.project_id})`;
                option.title = `Project ID: ${project.project_id}\nName: ${project.name}`;
                select.appendChild(option);
            });
        }

        // í˜„ì¬ ê¸°ë³¸ í”„ë¡œì íŠ¸ ì„ íƒ
        async function selectCurrentProject() {
            try {
                const response = await fetch('/api/gcp-projects/current');
                const result = await response.json();
                
                if (result.success && result.current_project) {
                    elements.gcpProjectId.value = result.current_project;
                    validateInputs();
                }
            } catch (error) {
                console.error('í˜„ì¬ í”„ë¡œì íŠ¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
            }
        }

        // ìˆ˜ë™ ì…ë ¥ ì˜µì…˜ ì¶”ê°€ (ì˜¤ë¥˜ ì‹œ)
        function addManualInputOption() {
            const select = elements.gcpProjectId;
            
            const manualOption = document.createElement('option');
            manualOption.value = '__manual__';
            manualOption.textContent = 'ì§ì ‘ ì…ë ¥...';
            select.appendChild(manualOption);
            
            // ì§ì ‘ ì…ë ¥ ì„ íƒ ì‹œ ì²˜ë¦¬
            select.addEventListener('change', function(e) {
                if (e.target.value === '__manual__') {
                    const projectId = prompt('GCP Project IDë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
                    if (projectId) {
                        // ìƒˆ ì˜µì…˜ ì¶”ê°€
                        const newOption = document.createElement('option');
                        newOption.value = projectId;
                        newOption.textContent = `${projectId} (ìˆ˜ë™ ì…ë ¥)`;
                        select.insertBefore(newOption, select.lastElementChild);
                        select.value = projectId;
                        validateInputs();
                        loadProjectTables();
                    } else {
                        select.value = '';
                    }
                } else if (e.target.value) {
                    // ì •ìƒì ì¸ í”„ë¡œì íŠ¸ ì„ íƒ ì‹œ í…Œì´ë¸” ëª©ë¡ ë¡œë“œ
                    loadProjectTables();
                }
            });
        }

        // í”„ë¡œì íŠ¸ í…Œì´ë¸” ëª©ë¡ ë¡œë“œ
        async function loadProjectTables() {
            const projectId = elements.gcpProjectId.value;
            
            if (!projectId || projectId === '__manual__') {
                resetTablesUI();
                return;
            }
            
            // UI ìƒíƒœ ì—…ë°ì´íŠ¸
            elements.tablesPlaceholder.classList.add('hidden');
            elements.tablesLoadingStatus.classList.remove('hidden');
            elements.tablesList.classList.add('hidden');
            elements.refreshTablesButton.disabled = true;
            
            try {
                const response = await fetch(`/api/gcp-projects/${encodeURIComponent(projectId)}/tables`);
                const result = await response.json();
                
                if (result.success) {
                    projectTables = result.tables;
                    displayTables(result.tables, result.summary);
                    elements.refreshTablesButton.disabled = false;
                } else {
                    throw new Error(result.error || 'í…Œì´ë¸” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('í…Œì´ë¸” ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                showTablesError(error.message);
            } finally {
                elements.tablesLoadingStatus.classList.add('hidden');
            }
        }

        // í…Œì´ë¸” ëª©ë¡ í‘œì‹œ
        function displayTables(tables, summary) {
            if (tables.length === 0) {
                elements.tablesPlaceholder.innerHTML = '<div class="p-3 text-sm text-gray-500 text-center">ì´ í”„ë¡œì íŠ¸ì—ëŠ” í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                elements.tablesPlaceholder.classList.remove('hidden');
                return;
            }
            
            // ë°ì´í„°ì…‹ë³„ë¡œ ê·¸ë£¹í™”
            const tablesByDataset = {};
            tables.forEach(table => {
                if (!tablesByDataset[table.dataset_id]) {
                    tablesByDataset[table.dataset_id] = [];
                }
                tablesByDataset[table.dataset_id].push(table);
            });
            
            let html = '';
            
            // ìš”ì•½ ì •ë³´
            html += `
                <div class="p-3 bg-gray-50 border-b text-xs text-gray-600">
                    ğŸ“Š ${summary.total_datasets}ê°œ ë°ì´í„°ì…‹, ${summary.total_tables}ê°œ í…Œì´ë¸”
                    ${summary.total_size_mb > 0 ? `(ì´ ${summary.total_size_mb.toFixed(1)}MB)` : ''}
                </div>
            `;
            
            // ë°ì´í„°ì…‹ë³„ í…Œì´ë¸” ëª©ë¡
            Object.keys(tablesByDataset).sort().forEach(datasetId => {
                const datasetTables = tablesByDataset[datasetId];
                
                html += `
                    <div class="border-b border-gray-100">
                        <div class="px-3 py-2 bg-gray-50 text-xs font-medium text-gray-700 flex justify-between items-center">
                            <span>ğŸ“ ${datasetId}</span>
                            <span class="text-gray-500">${datasetTables.length}ê°œ í…Œì´ë¸”</span>
                        </div>
                `;
                
                datasetTables.forEach(table => {
                    const isSelected = selectedTables.has(table.table_id);
                    const sizeInfo = table.size_mb > 0 ? ` (${table.size_mb}MB)` : '';
                    const rowInfo = table.num_rows !== null ? ` - ${table.num_rows.toLocaleString()}í–‰` : '';
                    
                    html += `
                        <div class="px-3 py-2 hover:bg-gray-50 border-b border-gray-50">
                            <label class="flex items-center cursor-pointer text-sm">
                                <input type="checkbox" 
                                       class="mr-2 table-checkbox" 
                                       data-table-id="${table.table_id}"
                                       ${isSelected ? 'checked' : ''}
                                       onchange="toggleTableSelection('${table.table_id}')">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-800">${table.table_name}</div>
                                    <div class="text-xs text-gray-500">
                                        ${table.table_id}${rowInfo}${sizeInfo}
                                        ${table.has_partition ? ' ğŸ”„' : ''}${table.has_clustering ? ' ğŸ”—' : ''}
                                    </div>
                                </div>
                            </label>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            elements.tablesList.innerHTML = html;
            elements.tablesList.classList.remove('hidden');
            elements.selectAllTablesButton.disabled = false;
            
            updateTableSelectionStatus();
        }

        // í…Œì´ë¸” ì„ íƒ/í•´ì œ
        function toggleTableSelection(tableId) {
            if (selectedTables.has(tableId)) {
                selectedTables.delete(tableId);
            } else {
                selectedTables.add(tableId);
            }
            updateTableSelectionStatus();
            validateInputs();
        }

        // ì „ì²´ í…Œì´ë¸” ì„ íƒ/í•´ì œ
        function toggleAllTables() {
            const checkboxes = document.querySelectorAll('.table-checkbox');
            const allSelected = selectedTables.size === projectTables.length;
            
            if (allSelected) {
                // ì „ì²´ í•´ì œ
                selectedTables.clear();
                checkboxes.forEach(cb => cb.checked = false);
            } else {
                // ì „ì²´ ì„ íƒ
                selectedTables.clear();
                projectTables.forEach(table => selectedTables.add(table.table_id));
                checkboxes.forEach(cb => cb.checked = true);
            }
            
            updateTableSelectionStatus();
            validateInputs();
        }

        // í…Œì´ë¸” ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateTableSelectionStatus() {
            const count = selectedTables.size;
            elements.tableSelectionStatus.textContent = `ì„ íƒëœ í…Œì´ë¸”: ${count}ê°œ`;
            
            // currentTableIds ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ì½”ë“œ í˜¸í™˜ì„±)
            currentTableIds = Array.from(selectedTables);
        }

        // í…Œì´ë¸” UI ì´ˆê¸°í™”
        function resetTablesUI() {
            elements.tablesPlaceholder.classList.remove('hidden');
            elements.tablesLoadingStatus.classList.add('hidden');
            elements.tablesList.classList.add('hidden');
            elements.tablesPlaceholder.innerHTML = '<div class="p-3 text-sm text-gray-500 text-center">ë¨¼ì € í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>';
            elements.refreshTablesButton.disabled = true;
            elements.selectAllTablesButton.disabled = true;
            
            projectTables = [];
            selectedTables.clear();
            updateTableSelectionStatus();
        }

        // í…Œì´ë¸” ë¡œë“œ ì˜¤ë¥˜ í‘œì‹œ
        function showTablesError(message) {
            elements.tablesPlaceholder.innerHTML = `
                <div class="p-3 text-sm text-red-600 text-center">
                    âŒ ${message}
                    <br>
                    <button onclick="loadProjectTables()" class="mt-2 text-xs text-blue-600 hover:text-blue-700">
                        ë‹¤ì‹œ ì‹œë„
                    </button>
                </div>
            `;
            elements.tablesPlaceholder.classList.remove('hidden');
            elements.refreshTablesButton.disabled = false;
        }

        // ì‚¬ì´ë“œë°” ì„¹ì…˜ í† ê¸€
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const isActive = content.classList.contains('active');
            
            // ëª¨ë“  ì„¹ì…˜ ë‹«ê¸°
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.remove('active');
            });
            
            // í´ë¦­í•œ ì„¹ì…˜ë§Œ ì—´ê¸° (ì´ë¯¸ ì—´ë ¤ìˆì§€ ì•Šì€ ê²½ìš°)
            if (!isActive) {
                content.classList.add('active');
            }
        }

        // ë¶„ì„ ëª¨ë“œ ì„ íƒ
        function selectAnalysisMode(mode) {
            selectedAnalysisMode = mode;
            
            // ëª¨ë“  ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
            document.querySelectorAll('.input-area button').forEach(btn => {
                btn.classList.remove('font-semibold');
            });
            
            // ì„ íƒëœ ë²„íŠ¼ ê°•ì¡°
            event.target.classList.add('font-semibold');
            
            updateInputStatus();
        }

        // ì…ë ¥ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateInputStatus() {
            if (!profilingCompleted) {
                elements.inputStatus.textContent = 'í”„ë¡œíŒŒì¼ë§ ì™„ë£Œ í›„ ì§ˆë¬¸ ê°€ëŠ¥';
            } else {
                const modeNames = {
                    'quick': 'ë¹ ë¥¸ ì¡°íšŒ',
                    'analyze': 'ìƒì„¸ ë¶„ì„', 
                    'creative-html': 'HTML ë¦¬í¬íŠ¸'
                };
                elements.inputStatus.textContent = `${modeNames[selectedAnalysisMode]} ëª¨ë“œ ì„ íƒë¨`;
            }
        }

        // í”„ë¡œíŒŒì¼ë§ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateProfilingUI(status, step = null, message = null) {
            const statusClass = {
                'inactive': 'status-inactive',
                'working': 'status-working', 
                'ready': 'status-ready',
                'error': 'status-error'
            };

            elements.profilingStatus.className = `status-indicator ${statusClass[status]}`;
            
            if (status === 'working') {
                elements.profilingProgress.classList.remove('hidden');
                elements.profilingIdle.classList.add('hidden');
                if (message) {
                    elements.currentStep.textContent = message;
                }
            } else if (status === 'ready') {
                elements.profilingProgress.classList.add('hidden');
                elements.profilingIdle.classList.remove('hidden');
                elements.profilingIdle.innerHTML = '<div class="text-green-600 text-sm">âœ… í”„ë¡œíŒŒì¼ë§ ì™„ë£Œ! ì´ì œ ì§ˆë¬¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
                
                // ì±„íŒ… ì…ë ¥ í™œì„±í™”
                elements.chatInput.disabled = false;
                elements.sendButton.disabled = false;
                profilingCompleted = true;
                updateInputStatus();
                
                // í™˜ì˜ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                showReadyMessage();
            }
        }

        // í”„ë¡œíŒŒì¼ë§ ì™„ë£Œ í›„ ë©”ì‹œì§€ í‘œì‹œ
        function showReadyMessage() {
            elements.messagesArea.innerHTML = `
                <div class="flex justify-center items-center h-full">
                    <div class="text-center max-w-md">
                        <div class="text-6xl mb-4">âœ…</div>
                        <h2 class="text-2xl font-semibold text-gray-900 mb-2">ì¤€ë¹„ ì™„ë£Œ!</h2>
                        <p class="text-gray-600 mb-6">ì´ì œ ë°ì´í„°ì— ëŒ€í•´ ììœ ë¡­ê²Œ ì§ˆë¬¸í•´ë³´ì„¸ìš”.</p>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-left">
                            <h3 class="font-medium text-green-900 mb-2">ì˜ˆì‹œ ì§ˆë¬¸:</h3>
                            <ul class="text-sm text-green-800 space-y-1">
                                <li>â€¢ í…Œì´ë¸”ì— ì´ ëª‡ ê°œì˜ ë ˆì½”ë“œê°€ ìˆë‚˜ìš”?</li>
                                <li>â€¢ ìƒìœ„ 10ê°œ ì¹´í…Œê³ ë¦¬ë¥¼ ë³´ì—¬ì£¼ì„¸ìš”</li>
                                <li>â€¢ ì›”ë³„ íŠ¸ë Œë“œë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        // ì…ë ¥ ê²€ì¦
        function validateInputs() {
            const projectId = elements.gcpProjectId.value.trim();
            const hasSelectedTables = selectedTables.size > 0;
            const isValid = projectId && hasSelectedTables;
            
            elements.startProfilingButton.disabled = !isValid;
            
            if (isValid) {
                elements.projectStatus.className = 'status-indicator status-ready';
            } else {
                elements.projectStatus.className = 'status-indicator status-inactive';
            }
        }

        // ì±„íŒ… ì…ë ¥ ìë™ í¬ê¸° ì¡°ì ˆ
        function autoResizeInput() {
            const input = elements.chatInput;
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 120) + 'px';
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(content, isUser = false, type = 'text') {
            // í™˜ì˜ ë©”ì‹œì§€ ì œê±°
            if (messageHistory.length === 0) {
                elements.messagesArea.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble ${isUser ? 'user-message' : 'ai-message'}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'p-4';
            
            if (type === 'html') {
                contentDiv.innerHTML = content;
            } else if (type === 'markdown') {
                contentDiv.innerHTML = marked.parse(content);
            } else {
                contentDiv.textContent = content;
            }
            
            messageDiv.appendChild(contentDiv);
            elements.messagesArea.appendChild(messageDiv);
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            elements.messagesArea.scrollTop = elements.messagesArea.scrollHeight;
            
            // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
            messageHistory.push({
                content: content,
                isUser: isUser,
                type: type,
                timestamp: new Date().toISOString()
            });
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        elements.gcpProjectId.addEventListener('change', function() {
            validateInputs();
            if (this.value && this.value !== '__manual__') {
                loadProjectTables();
            } else {
                resetTablesUI();
            }
        });
        elements.chatInput.addEventListener('input', autoResizeInput);
        
        elements.chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        elements.sendButton.addEventListener('click', sendMessage);
        elements.startProfilingButton.addEventListener('click', startProfiling);
        elements.refreshHistoryButton.addEventListener('click', loadHistory);

        // ë©”ì‹œì§€ ì „ì†¡
        function sendMessage() {
            const message = elements.chatInput.value.trim();
            if (!message || !profilingCompleted) return;
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            addMessage(message, true);
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            elements.chatInput.value = '';
            autoResizeInput();
            
            // AI ì‘ë‹µ (ì„ì‹œ)
            setTimeout(() => {
                addMessage('ë©”ì‹œì§€ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤. í˜„ì¬ Phase 1 ë‹¨ê³„ë¡œ ì‹¤ì œ ë¶„ì„ ê¸°ëŠ¥ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ êµ¬í˜„ë©ë‹ˆë‹¤.', false);
            }, 500);
        }

        // í”„ë¡œíŒŒì¼ë§ ì‹œì‘ (ì„ì‹œ)
        function startProfiling() {
            currentProjectId = elements.gcpProjectId.value.trim();
            currentTableIds = Array.from(selectedTables);
            
            if (!currentProjectId || currentTableIds.length === 0) {
                alert('í”„ë¡œì íŠ¸ì™€ í…Œì´ë¸”ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            updateProfilingUI('working');
            elements.startProfilingButton.disabled = true;
            elements.startProfilingButton.textContent = 'í”„ë¡œíŒŒì¼ë§ ì¤‘...';
            
            // ì„ì‹œ í”„ë¡œíŒŒì¼ë§ ì‹œë®¬ë ˆì´ì…˜
            setTimeout(() => {
                updateProfilingUI('ready');
                elements.startProfilingButton.disabled = false;
                elements.startProfilingButton.textContent = 'ë‹¤ì‹œ ì‹¤í–‰';
            }, 3000);
        }

        // ê¸°ë¡ ë¡œë“œ (ì„ì‹œ)
        function loadHistory() {
            elements.historyList.innerHTML = `
                <div class="text-sm text-gray-500">
                    Phase 1: ê¸°ë³¸ UIë§Œ êµ¬í˜„ë¨<br>
                    ì‹¤ì œ ê¸°ë¡ ê¸°ëŠ¥ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ êµ¬í˜„
                </div>
            `;
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            validateInputs();
            updateInputStatus();
            
            // ê¸°ë³¸ì ìœ¼ë¡œ í”„ë¡œì íŠ¸ ì„¤ì • ì„¹ì…˜ë§Œ ì—´ë ¤ìˆë„ë¡
            document.getElementById('project-settings').classList.add('active');
            
            // GCP í”„ë¡œì íŠ¸ ëª©ë¡ ìë™ ë¡œë“œ
            loadGcpProjects();
            
            console.log('BigQuery AI Assistant Phase 1 ë¡œë“œ ì™„ë£Œ');
        });
    </script>
</body>
</html>