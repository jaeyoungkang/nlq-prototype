<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>통합 BigQuery 데이터 분석기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif; }
        .status-item.completed .icon { color: #22c55e; }
        .status-item.active .icon { animation: spin 1s linear infinite; }
        .status-item.error .icon { color: #ef4444; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        code { font-family: 'D2Coding', 'Courier New', monospace; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        .prose h1, .prose h2, .prose h3 { color: #1f2937; }
        .prose code { background-color: #f3f4f6; padding: 0.125rem 0.25rem; border-radius: 0.25rem; }
        .tab-button.active { background: #4285f4; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .mode-card { transition: all 0.3s ease; }
        .mode-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .analysis-result { max-height: 600px; overflow-y: auto; }
        .chart-container { position: relative; height: 400px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- 헤더 -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">🚀 통합 BigQuery 분석기</h1>
            <p class="text-gray-600 text-lg mb-4">Claude AI 기반 동적 스키마 분석 및 자연어 질의 시스템</p>
            <div class="flex justify-center space-x-4 text-sm">
                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full">실시간 프로파일링</span>
                <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full">3가지 분석 모드</span>
                <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full">Claude 3.5 Sonnet</span>
            </div>
        </header>

        <!-- 메인 탭 네비게이션 -->
        <div class="bg-white rounded-xl shadow-lg mb-8 border border-gray-200">
            <div class="flex border-b border-gray-200">
                <button id="setupTab" class="tab-button flex-1 py-4 px-6 text-lg font-semibold rounded-tl-xl bg-blue-600 text-white">
                    📊 데이터 설정
                </button>
                <button id="profilingTab" class="tab-button flex-1 py-4 px-6 text-lg font-semibold text-gray-600 hover:text-blue-600">
                    🔍 프로파일링
                </button>
                <button id="analysisTab" class="tab-button flex-1 py-4 px-6 text-lg font-semibold text-gray-600 hover:text-blue-600">
                    💡 자연어 분석
                </button>
                <button id="historyTab" class="tab-button flex-1 py-4 px-6 text-lg font-semibold rounded-tr-xl text-gray-600 hover:text-blue-600">
                    📋 기록 조회
                </button>
            </div>

            <!-- 데이터 설정 탭 -->
            <div id="setupContent" class="tab-content active p-6 md:p-8">
                <div class="space-y-6">
                    <div>
                        <label for="gcpProjectId" class="block text-sm font-medium text-gray-700 mb-2">
                            GCP Project ID <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="gcpProjectId" 
                               class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="my-gcp-project"
                               value="">
                    </div>
                    <div>
                        <label for="tableIds" class="block text-sm font-medium text-gray-700 mb-2">
                            BigQuery Table IDs <span class="text-red-500">*</span>
                            <span class="text-gray-500 font-normal">(쉼표 또는 줄바꿈으로 구분)</span>
                        </label>
                        <textarea id="tableIds" rows="4" 
                                  class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                  placeholder="project.dataset.table1,&#10;project.dataset.table2"></textarea>
                        <div class="mt-2 text-xs text-gray-500">
                            예시: bigquery-public-data.google_ads_transparency_center.creative_stats
                        </div>
                    </div>
                    <div class="flex justify-center">
                        <button id="startProfilingButton" 
                                class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-semibold py-3 px-8 rounded-lg text-lg transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:transform-none">
                            🚀 프로파일링 시작하기
                        </button>
                    </div>
                </div>
            </div>

            <!-- 프로파일링 탭 -->
            <div id="profilingContent" class="tab-content p-6 md:p-8">
                <!-- 진행 상황 -->
                <div id="progressSection" class="mb-8 hidden">
                    <h2 class="text-2xl font-bold mb-6 text-center text-gray-900">프로파일링 진행 상황</h2>
                    <div id="statusContainer" class="space-y-4 mb-8"></div>
                    <div class="bg-gray-900 text-green-400 font-mono text-sm rounded-lg p-4 h-48 overflow-y-auto">
                        <div id="liveLogContainer"></div>
                    </div>
                </div>
                
                <!-- 프로파일링 결과 -->
                <div id="profilingResults" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-gray-900">📊 데이터 프로파일링 리포트</h2>
                    <div id="profilingReportContent" class="space-y-6"></div>
                </div>
            </div>

            <!-- 자연어 분석 탭 -->
            <div id="analysisContent" class="tab-content p-6 md:p-8">
                <div id="analysisSetupSection">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">🤖 자연어 질의 분석</h2>
                        <p class="text-gray-600">프로파일링이 완료된 후 자연어로 데이터를 분석할 수 있습니다.</p>
                    </div>
                    
                    <!-- 분석 모드 선택 -->
                    <div class="grid md:grid-cols-3 gap-6 mb-8" id="analysisModesSection" style="display: none;">
                        <div class="mode-card bg-white border-2 border-blue-200 rounded-xl p-6 cursor-pointer hover:border-blue-400" data-mode="quick">
                            <div class="text-center">
                                <div class="text-4xl mb-4">⚡</div>
                                <h3 class="text-xl font-bold text-gray-900 mb-2">빠른 조회</h3>
                                <p class="text-gray-600 text-sm">기본 데이터 조회 및 SQL 실행</p>
                            </div>
                        </div>
                        <div class="mode-card bg-white border-2 border-green-200 rounded-xl p-6 cursor-pointer hover:border-green-400" data-mode="analyze">
                            <div class="text-center">
                                <div class="text-4xl mb-4">📊</div>
                                <h3 class="text-xl font-bold text-gray-900 mb-2">구조화된 분석</h3>
                                <p class="text-gray-600 text-sm">차트 + 상세 분석 리포트</p>
                            </div>
                        </div>
                        <div class="mode-card bg-white border-2 border-purple-200 rounded-xl p-6 cursor-pointer hover:border-purple-400" data-mode="creative-html">
                            <div class="text-center">
                                <div class="text-4xl mb-4">🎨</div>
                                <h3 class="text-xl font-bold text-gray-900 mb-2">창의적 HTML</h3>
                                <p class="text-gray-600 text-sm">완전한 HTML 분석 리포트</p>
                            </div>
                        </div>
                    </div>

                    <!-- 질문 입력 섹션 -->
                    <div id="questionSection" style="display: none;">
                        <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
                            <label for="naturalLanguageQuery" class="block text-sm font-medium text-gray-700 mb-2">
                                자연어 질문 <span class="text-red-500">*</span>
                            </label>
                            <textarea id="naturalLanguageQuery" rows="3" 
                                      class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                      placeholder="예: 가장 많이 사용되는 기기 카테고리는 무엇인가요?"></textarea>
                            <div class="flex justify-between items-center mt-4">
                                <div class="text-sm text-gray-500">
                                    선택된 모드: <span id="selectedModeDisplay" class="font-semibold text-blue-600"></span>
                                </div>
                                <button id="executeAnalysisButton" 
                                        class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition-all">
                                    분석 실행
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 분석 결과 -->
                <div id="analysisResults" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">분석 결과</h2>
                        <button id="newAnalysisButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">
                            새 분석
                        </button>
                    </div>
                    <div id="analysisResultContent" class="analysis-result"></div>
                </div>
            </div>

            <!-- 기록 조회 탭 -->
            <div id="historyContent" class="tab-content p-6 md:p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">📋 작업 기록</h2>
                    <button id="refreshHistoryButton" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">
                        새로고침
                    </button>
                </div>
                <div id="historyContainer" class="space-y-4">
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-6xl mb-4">📝</div>
                        <p>아직 기록이 없습니다. 프로파일링을 시작해보세요!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 푸터 -->
        <footer class="text-center text-gray-500 text-sm py-8 border-t border-gray-200">
            <p>© 2024 통합 BigQuery 분석기. Claude AI 기반 동적 스키마 분석 도구.</p>
        </footer>
    </div>

    <!-- JavaScript -->
    <script>
        // 전역 변수
        let currentProjectId = '';
        let currentTableIds = [];
        let selectedAnalysisMode = '';
        let profilingCompleted = false;
        let currentSessionId = '';

        // DOM 요소 참조
        const elements = {
            // 탭 관련
            setupTab: document.getElementById('setupTab'),
            profilingTab: document.getElementById('profilingTab'),
            analysisTab: document.getElementById('analysisTab'),
            historyTab: document.getElementById('historyTab'),
            
            setupContent: document.getElementById('setupContent'),
            profilingContent: document.getElementById('profilingContent'),
            analysisContent: document.getElementById('analysisContent'),
            historyContent: document.getElementById('historyContent'),
            
            // 설정 관련
            gcpProjectId: document.getElementById('gcpProjectId'),
            tableIds: document.getElementById('tableIds'),
            startProfilingButton: document.getElementById('startProfilingButton'),
            
            // 프로파일링 관련
            progressSection: document.getElementById('progressSection'),
            statusContainer: document.getElementById('statusContainer'),
            liveLogContainer: document.getElementById('liveLogContainer'),
            profilingResults: document.getElementById('profilingResults'),
            profilingReportContent: document.getElementById('profilingReportContent'),
            
            // 분석 관련
            analysisModesSection: document.getElementById('analysisModesSection'),
            questionSection: document.getElementById('questionSection'),
            naturalLanguageQuery: document.getElementById('naturalLanguageQuery'),
            selectedModeDisplay: document.getElementById('selectedModeDisplay'),
            executeAnalysisButton: document.getElementById('executeAnalysisButton'),
            analysisResults: document.getElementById('analysisResults'),
            analysisResultContent: document.getElementById('analysisResultContent'),
            newAnalysisButton: document.getElementById('newAnalysisButton'),
            
            // 기록 관련
            refreshHistoryButton: document.getElementById('refreshHistoryButton'),
            historyContainer: document.getElementById('historyContainer')
        };

        // 탭 관리
        function initializeTabs() {
            const tabButtons = [elements.setupTab, elements.profilingTab, elements.analysisTab, elements.historyTab];
            const tabContents = [elements.setupContent, elements.profilingContent, elements.analysisContent, elements.historyContent];

            tabButtons.forEach((button, index) => {
                button.addEventListener('click', () => {
                    // 모든 탭 비활성화
                    tabButtons.forEach(btn => btn.classList.remove('active', 'bg-blue-600', 'text-white'));
                    tabButtons.forEach(btn => btn.classList.add('text-gray-600', 'hover:text-blue-600'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // 선택된 탭 활성화
                    button.classList.add('active', 'bg-blue-600', 'text-white');
                    button.classList.remove('text-gray-600', 'hover:text-blue-600');
                    tabContents[index].classList.add('active');
                    
                    // 기록 탭 선택 시 자동 로드
                    if (index === 3) {
                        loadHistory();
                    }
                });
            });
        }

        // 입력 검증
        function validateInputs() {
            const projectId = elements.gcpProjectId.value.trim();
            const tables = elements.tableIds.value.trim();
            const isValid = projectId && tables;
            
            elements.startProfilingButton.disabled = !isValid;
            
            if (isValid) {
                elements.startProfilingButton.classList.remove('bg-gray-400');
                elements.startProfilingButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else {
                elements.startProfilingButton.classList.add('bg-gray-400');
                elements.startProfilingButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }
        }

        // 프로파일링 상태 초기화
        function initializeProfilingStatus() {
            elements.statusContainer.innerHTML = '';
            elements.liveLogContainer.innerHTML = '';
            
            const steps = [
                { id: 0, text: "메타데이터 추출 준비" },
                { id: 1, text: "테이블 메타데이터 추출" },
                { id: 2, text: "프로파일링 리포트 생성" },
                { id: 3, text: "결과 저장" },
                { id: 4, text: "프로파일링 완료" }
            ];

            steps.forEach(step => {
                const statusItem = document.createElement('div');
                statusItem.id = `status-${step.id}`;
                statusItem.className = 'status-item flex items-center text-gray-500 p-3 rounded-lg bg-gray-50';
                statusItem.innerHTML = `
                    <span class="icon w-6 h-6 mr-4 flex-shrink-0">⏳</span>
                    <span class="font-medium">${step.text}</span>
                `;
                elements.statusContainer.appendChild(statusItem);
            });
        }

        // 프로파일링 상태 업데이트
        function updateProfilingStatus(payload) {
            const { step, message, session_id } = payload;
            
            if (session_id) {
                currentSessionId = session_id;
            }
            
            const itemToUpdate = document.getElementById(`status-${step}`);
            if (!itemToUpdate) return;
            
            const icon = itemToUpdate.querySelector('.icon');
            const text = itemToUpdate.querySelector('span:last-child');
            
            // 이전 단계들을 완료 상태로 변경
            for (let i = 0; i < step; i++) {
                const prevStepEl = document.getElementById(`status-${i}`);
                if (prevStepEl && !prevStepEl.classList.contains('error')) {
                   prevStepEl.classList.remove('text-gray-500', 'active', 'bg-gray-50');
                   prevStepEl.classList.add('completed', 'text-green-700', 'bg-green-50');
                   prevStepEl.querySelector('.icon').innerHTML = '✅';
                }
            }

            // 현재 단계를 활성 상태로 변경
            itemToUpdate.classList.remove('text-gray-500', 'bg-gray-50');
            itemToUpdate.classList.add('active', 'text-blue-700', 'bg-blue-50');
            text.textContent = message;
            icon.innerHTML = '<svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
        }

        // 로그 메시지 추가
        function appendLogMessage(payload) {
            const logLine = document.createElement('div');
            logLine.innerHTML = `<span class="text-yellow-400">[${new Date().toLocaleTimeString()}]</span> <span class="text-green-400">${payload.message}</span>`;
            elements.liveLogContainer.appendChild(logLine);
            elements.liveLogContainer.scrollTop = elements.liveLogContainer.scrollHeight;
        }

        // 프로파일링 완료 처리
        function handleProfilingComplete() {
            // 모든 단계를 완료 상태로 변경
            for (let i = 0; i < 5; i++) {
                const stepEl = document.getElementById(`status-${i}`);
                if (stepEl) {
                    stepEl.classList.remove('active', 'text-blue-700', 'bg-blue-50');
                    stepEl.classList.add('completed', 'text-green-700', 'bg-green-50');
                    stepEl.querySelector('.icon').innerHTML = '✅';
                }
            }
            
            elements.startProfilingButton.disabled = false;
            elements.startProfilingButton.textContent = '🔄 다시 프로파일링';
            elements.startProfilingButton.classList.remove('bg-gray-400');
            elements.startProfilingButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            
            profilingCompleted = true;
            
            // 분석 모드 섹션 활성화
            elements.analysisModesSection.style.display = 'grid';
            
            // 분석 탭으로 자동 이동 (선택사항)
            setTimeout(() => {
                elements.analysisTab.click();
            }, 2000);
        }

        // 프로파일링 리포트 섹션 추가
        function addProfilingReportSection(sectionData) {
            const { section, title, content } = sectionData;
            
            const sectionElement = document.createElement('div');
            sectionElement.id = `section-${section}`;
            sectionElement.className = 'mb-6 border border-gray-200 rounded-lg overflow-hidden';
            
            const icons = {
                'overview': '📋',
                'table_analysis': '📊',
                'relationships': '🔗',
                'business_questions': '❓',
                'recommendations': '💡'
            };
            
            sectionElement.innerHTML = `
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center">
                        <span class="text-2xl mr-3">${icons[section] || '📄'}</span>${title}
                    </h3>
                </div>
                <div class="p-6 bg-white">
                    <div class="prose max-w-none">${marked.parse(content)}</div>
                </div>
            `;
            
            elements.profilingReportContent.appendChild(sectionElement);
            
            // 프로파일링 결과 섹션 표시
            elements.profilingResults.classList.remove('hidden');
            
            sectionElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // 프로파일링 시작
        function startProfiling() {
            currentProjectId = elements.gcpProjectId.value.trim();
            const tablesInput = elements.tableIds.value.trim();
            currentTableIds = tablesInput.split(/[,\n]+/).map(s => s.trim()).filter(Boolean);
            
            if (!currentProjectId || currentTableIds.length === 0) {
                alert('Project ID와 Table IDs를 모두 입력해주세요.');
                return;
            }
            
            // UI 상태 변경
            elements.startProfilingButton.disabled = true;
            elements.startProfilingButton.textContent = '⏳ 프로파일링 진행 중...';
            elements.startProfilingButton.classList.add('bg-gray-400');
            
            // 프로파일링 탭으로 이동
            elements.profilingTab.click();
            
            // 상태 초기화 및 표시
            initializeProfilingStatus();
            elements.progressSection.classList.remove('hidden');
            elements.profilingResults.classList.add('hidden');
            elements.profilingReportContent.innerHTML = '';
            
            // SSE 연결
            const eventSourceUrl = `/profiling?projectId=${encodeURIComponent(currentProjectId)}&tableIds=${encodeURIComponent(currentTableIds.join(','))}`;
            const eventSource = new EventSource(eventSourceUrl);
            
            eventSource.onmessage = function (event) {
                const eventData = JSON.parse(event.data);
                
                switch (eventData.type) {
                    case 'status':
                        updateProfilingStatus(eventData.payload);
                        break;
                    case 'log':
                        appendLogMessage(eventData.payload);
                        break;
                    case 'report_section':
                        addProfilingReportSection(eventData.payload);
                        break;
                    case 'profiling_complete':
                        handleProfilingComplete();
                        eventSource.close();
                        break;
                    case 'error':
                        appendLogMessage({ message: `❌ 오류: ${eventData.payload.message}` });
                        handleProfilingError(eventData.payload.message);
                        eventSource.close();
                        break;
                }
            };

            eventSource.onerror = function(err) {
                console.error("EventSource failed:", err);
                appendLogMessage({ message: "❌ 서버 연결 오류 발생." });
                handleProfilingError("서버 연결에 실패했습니다.");
                eventSource.close();
            };
        }

        // 프로파일링 오류 처리
        function handleProfilingError(message) {
            const errorStep = document.getElementById('status-0');
            if (errorStep) {
                errorStep.classList.add('error', 'text-red-700', 'bg-red-50');
                errorStep.querySelector('.icon').innerHTML = '❌';
                errorStep.querySelector('span:last-child').textContent = message || '오류 발생';
            }
            
            elements.startProfilingButton.disabled = false;
            elements.startProfilingButton.textContent = '🔄 다시 시도';
            elements.startProfilingButton.classList.remove('bg-gray-400');
            elements.startProfilingButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }

        // 분석 모드 선택
        function initializeAnalysisModes() {
            const modeCards = document.querySelectorAll('.mode-card');
            
            modeCards.forEach(card => {
                card.addEventListener('click', () => {
                    // 모든 카드 비활성화
                    modeCards.forEach(c => {
                        c.classList.remove('border-blue-500', 'border-green-500', 'border-purple-500', 'bg-blue-50', 'bg-green-50', 'bg-purple-50');
                        c.classList.add('border-gray-200');
                    });
                    
                    // 선택된 카드 활성화
                    const mode = card.dataset.mode;
                    selectedAnalysisMode = mode;
                    
                    if (mode === 'quick') {
                        card.classList.remove('border-gray-200');
                        card.classList.add('border-blue-500', 'bg-blue-50');
                        elements.selectedModeDisplay.textContent = '빠른 조회';
                    } else if (mode === 'analyze') {
                        card.classList.remove('border-gray-200');
                        card.classList.add('border-green-500', 'bg-green-50');
                        elements.selectedModeDisplay.textContent = '구조화된 분석';
                    } else if (mode === 'creative-html') {
                        card.classList.remove('border-gray-200');
                        card.classList.add('border-purple-500', 'bg-purple-50');
                        elements.selectedModeDisplay.textContent = '창의적 HTML';
                    }
                    
                    // 질문 섹션 표시
                    elements.questionSection.style.display = 'block';
                });
            });
        }

        // 자연어 분석 실행
        async function executeAnalysis() {
            const question = elements.naturalLanguageQuery.value.trim();
            
            if (!question) {
                alert('질문을 입력해주세요.');
                return;
            }
            
            if (!selectedAnalysisMode) {
                alert('분석 모드를 선택해주세요.');
                return;
            }
            
            if (!profilingCompleted) {
                alert('먼저 프로파일링을 완료해주세요.');
                return;
            }
            
            // UI 상태 변경
            elements.executeAnalysisButton.disabled = true;
            elements.executeAnalysisButton.textContent = '분석 중...';
            
            try {
                const requestData = {
                    question: question,
                    project_id: currentProjectId,
                    table_ids: currentTableIds
                };
                
                const response = await fetch(`/${selectedAnalysisMode}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayAnalysisResult(result);
                } else {
                    throw new Error(result.error || '분석 실행 중 오류가 발생했습니다.');
                }
                
            } catch (error) {
                console.error('Analysis error:', error);
                alert(`분석 실행 중 오류: ${error.message}`);
            } finally {
                elements.executeAnalysisButton.disabled = false;
                elements.executeAnalysisButton.textContent = '분석 실행';
            }
        }

        // 분석 결과 표시
        function displayAnalysisResult(result) {
            elements.analysisResults.classList.remove('hidden');
            
            let resultHTML = '';
            
            if (result.mode === 'quick') {
                resultHTML = generateQuickResultHTML(result);
            } else if (result.mode === 'structured') {
                resultHTML = generateStructuredResultHTML(result);
            } else if (result.mode === 'creative_html') {
                resultHTML = generateCreativeHTMLResult(result);
            }
            
            elements.analysisResultContent.innerHTML = resultHTML;
            elements.analysisResultContent.scrollIntoView({ behavior: 'smooth' });
        }

        // 빠른 조회 결과 HTML 생성
        function generateQuickResultHTML(result) {
            const { original_question, generated_sql, data, row_count } = result;
            
            let tableHTML = '';
            if (data && data.length > 0) {
                const columns = Object.keys(data[0]);
                const headerHTML = columns.map(col => `<th class="px-4 py-2 bg-blue-500 text-white">${col}</th>`).join('');
                const rowsHTML = data.slice(0, 20).map(row => 
                    `<tr>${columns.map(col => `<td class="px-4 py-2 border">${row[col] || ''}</td>`).join('')}</tr>`
                ).join('');
                
                tableHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full border-collapse border border-gray-300">
                            <thead><tr>${headerHTML}</tr></thead>
                            <tbody>${rowsHTML}</tbody>
                        </table>
                    </div>
                `;
            }
            
            return `
                <div class="bg-white rounded-lg border border-gray-200 p-6 space-y-6">
                    <div class="border-b pb-4">
                        <h3 class="text-xl font-bold text-gray-900 mb-2">⚡ 빠른 조회 결과</h3>
                        <p class="text-gray-600"><strong>질문:</strong> ${original_question}</p>
                        <p class="text-gray-600"><strong>결과:</strong> ${row_count}개 행</p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">🔍 생성된 SQL</h4>
                        <pre class="bg-gray-100 p-4 rounded-lg overflow-x-auto"><code>${generated_sql}</code></pre>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">📊 데이터 (상위 20개)</h4>
                        ${tableHTML || '<p class="text-gray-500">조회된 데이터가 없습니다.</p>'}
                    </div>
                </div>
            `;
        }

        // 구조화된 분석 결과 HTML 생성
        function generateStructuredResultHTML(result) {
            const { original_question, generated_sql, data, row_count, analysis_report, chart_config } = result;
            
            let chartHTML = '';
            if (chart_config && data && data.length > 0) {
                chartHTML = `
                    <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
                        <h4 class="font-semibold text-gray-800 mb-4">📈 시각화</h4>
                        <div class="chart-container">
                            <canvas id="analysisChart"></canvas>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="space-y-6">
                    <div class="bg-white rounded-lg border border-gray-200 p-6">
                        <h3 class="text-xl font-bold text-gray-900 mb-2">📊 구조화된 분석 결과</h3>
                        <p class="text-gray-600"><strong>질문:</strong> ${original_question}</p>
                        <p class="text-gray-600"><strong>결과:</strong> ${row_count}개 행</p>
                    </div>
                    
                    ${chartHTML}
                    
                    <div class="bg-white rounded-lg border border-gray-200 p-6">
                        <h4 class="font-semibold text-gray-800 mb-4">📋 분석 리포트</h4>
                        <div class="prose max-w-none">${marked.parse(analysis_report || '분석 리포트가 생성되지 않았습니다.')}</div>
                    </div>
                    
                    <div class="bg-white rounded-lg border border-gray-200 p-6">
                        <h4 class="font-semibold text-gray-800 mb-2">🔍 생성된 SQL</h4>
                        <pre class="bg-gray-100 p-4 rounded-lg overflow-x-auto"><code>${generated_sql}</code></pre>
                    </div>
                </div>
            `;
        }

        // 창의적 HTML 결과 처리
        function generateCreativeHTMLResult(result) {
            const { original_question, html_content, quality_score, is_fallback } = result;
            
            return `
                <div class="bg-white rounded-lg border border-gray-200 p-6 space-y-6">
                    <div class="border-b pb-4">
                        <h3 class="text-xl font-bold text-gray-900 mb-2">🎨 창의적 HTML 리포트</h3>
                        <p class="text-gray-600"><strong>질문:</strong> ${original_question}</p>
                        <p class="text-gray-600"><strong>품질 점수:</strong> ${quality_score}/100 ${is_fallback ? '(폴백 모드)' : ''}</p>
                    </div>
                    
                    <div class="border rounded-lg overflow-hidden">
                        <div class="bg-gray-100 px-4 py-2 text-sm text-gray-600 border-b">
                            생성된 HTML 리포트 미리보기
                        </div>
                        <iframe srcdoc="${html_content.replace(/"/g, '&quot;')}" 
                                class="w-full h-96 border-0"></iframe>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button onclick="downloadHTML('${original_question}', \`${html_content.replace(/`/g, '\\`')}\`)" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            📥 HTML 다운로드
                        </button>
                        <button onclick="openHTMLInNewTab(\`${html_content.replace(/`/g, '\\`')}\`)" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                            🚀 새 탭에서 열기
                        </button>
                    </div>
                </div>
            `;
        }

        // 기록 로드
        async function loadHistory() {
            try {
                const response = await fetch('/logs');
                const logs = await response.json();
                
                if (!Array.isArray(logs) || logs.length === 0) {
                    elements.historyContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-6xl mb-4">📝</div>
                            <p>저장된 작업 기록이 없습니다.</p>
                            <p class="text-sm mt-2">프로파일링을 실행하면 기록이 여기에 표시됩니다.</p>
                        </div>
                    `;
                    return;
                }
                
                const historyHTML = logs.map(log => generateHistoryItemHTML(log)).join('');
                elements.historyContainer.innerHTML = historyHTML;
                
            } catch (error) {
                console.error('History loading error:', error);
                elements.historyContainer.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <div class="text-6xl mb-4">❌</div>
                        <p>기록을 불러오는 중 오류가 발생했습니다.</p>
                    </div>
                `;
            }
        }

        // 기록 항목 HTML 생성
        function generateHistoryItemHTML(log) {
            const statusColor = log.status === '완료' ? 'text-green-600 bg-green-50' : 
                              (log.status === '실패' ? 'text-red-600 bg-red-50' : 'text-yellow-600 bg-yellow-50');
            const statusIcon = log.status === '완료' ? '✅' : (log.status === '실패' ? '❌' : '⏳');
            
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${statusIcon}</span>
                            <div>
                                <span class="font-semibold ${statusColor} px-3 py-1 rounded-full text-sm">${log.status}</span>
                                <p class="text-gray-600 mt-1">${new Date(log.start_time).toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="text-right text-sm text-gray-500">
                            <p><strong>프로젝트:</strong> ${log.project_id}</p>
                            <p><strong>테이블:</strong> ${(log.table_ids || []).length}개</p>
                        </div>
                    </div>
                    
                    <div class="text-sm text-gray-600">
                        <p><strong>테이블 목록:</strong> ${(log.table_ids || []).join(', ')}</p>
                        ${log.error_message ? `<p class="text-red-600 mt-2"><strong>오류:</strong> ${log.error_message}</p>` : ''}
                    </div>
                </div>
            `;
        }

        // 유틸리티 함수들
        function downloadHTML(title, content) {
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title.replace(/[^a-zA-Z0-9]/g, '_')}_report.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function openHTMLInNewTab(content) {
            const newWindow = window.open();
            newWindow.document.write(content);
            newWindow.document.close();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // 간단한 알림 표시
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                notification.textContent = '클립보드에 복사되었습니다.';
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 2000);
            });
        }

        // 이벤트 리스너 등록
        function initializeEventListeners() {
            // 입력 검증
            elements.gcpProjectId.addEventListener('input', validateInputs);
            elements.tableIds.addEventListener('input', validateInputs);
            
            // 프로파일링 시작
            elements.startProfilingButton.addEventListener('click', startProfiling);
            
            // 분석 실행
            elements.executeAnalysisButton.addEventListener('click', executeAnalysis);
            
            // 새 분석 버튼
            elements.newAnalysisButton.addEventListener('click', () => {
                elements.analysisResults.classList.add('hidden');
                elements.naturalLanguageQuery.value = '';
                selectedAnalysisMode = '';
                elements.selectedModeDisplay.textContent = '';
                elements.questionSection.style.display = 'none';
                
                // 모든 모드 카드 비활성화
                document.querySelectorAll('.mode-card').forEach(card => {
                    card.classList.remove('border-blue-500', 'border-green-500', 'border-purple-500', 'bg-blue-50', 'bg-green-50', 'bg-purple-50');
                    card.classList.add('border-gray-200');
                });
            });
            
            // 기록 새로고침
            elements.refreshHistoryButton.addEventListener('click', loadHistory);
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', function () {
            initializeTabs();
            initializeAnalysisModes();
            initializeEventListeners();
            validateInputs();
            
            console.log('통합 BigQuery 분석기 초기화 완료');
        });
    </script>
</body>
</html>