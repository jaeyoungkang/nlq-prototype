{% extends "layout.html" %}

{% block title %}ì±„íŒ… - BigQuery AI Assistant{% endblock %}

{% block content %}
<div class="w-full h-full flex flex-col">
    <!-- ìƒë‹¨ í—¤ë” -->
    <header class="p-4 border-b border-gray-200 bg-white flex justify-between items-center">
        <h2 class="text-lg font-semibold text-gray-800">ë¶„ì„ ì±„íŒ…</h2>
        <div class="flex items-center space-x-4">
            <div id="profilingStatusWrapper" class="flex items-center text-sm text-gray-600">
                <span class="status-indicator status-inactive" id="profiling-status-indicator"></span>
                <span id="profilingStatus">ëŒ€ê¸° ì¤‘</span>
            </div>
            <button id="startProfilingButton" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg text-sm transition-colors disabled:bg-gray-400"
                    disabled>
                í”„ë¡œíŒŒì¼ë§ ì‹œì‘
            </button>
        </div>
    </header>

    <!-- ë©”ì‹œì§€ ì˜ì—­ -->
    <div class="messages-area flex-1 bg-gray-50" id="messagesArea">
        <!-- ì´ˆê¸° ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
    </div>

    <!-- ì…ë ¥ ì˜ì—­ -->
    <div class="input-area">
        <div class="relative flex items-center">
            <textarea id="chatInput" 
                      class="w-full border border-gray-300 rounded-lg py-2 pl-4 pr-24 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" 
                      placeholder="ë°ì´í„°ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”..." 
                      rows="1" 
                      disabled></textarea>
            <button id="sendButton" class="absolute right-2 bg-blue-600 text-white rounded-md p-2 disabled:bg-gray-400" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                </svg>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentSettings = { projectId: null, tableIds: [] };
    let profilingCompleted = false;

    const elements = {
        startProfilingButton: document.getElementById('startProfilingButton'),
        profilingStatusIndicator: document.getElementById('profiling-status-indicator'),
        profilingStatus: document.getElementById('profilingStatus'),
        messagesArea: document.getElementById('messagesArea'),
        chatInput: document.getElementById('chatInput'),
        sendButton: document.getElementById('sendButton'),
        selectedTablesNavList: document.getElementById('selected-tables-nav-list'),
    };

    function updateSelectedTablesNav() {
        if (!elements.selectedTablesNavList) return;
        elements.selectedTablesNavList.innerHTML = '';

        if (!currentSettings.tableIds || currentSettings.tableIds.length === 0) {
            elements.selectedTablesNavList.innerHTML = '<li class="px-3 py-1 text-sm text-gray-400">í…Œì´ë¸”ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</li>';
        } else {
            currentSettings.tableIds.forEach(tableId => {
                const li = document.createElement('li');
                li.className = 'px-3 py-1 text-sm text-gray-700 truncate';
                li.textContent = tableId.split('.').pop();
                li.title = tableId;
                elements.selectedTablesNavList.appendChild(li);
            });
        }
    }

    function loadSettings() {
        const savedSettings = localStorage.getItem('bigqueryAISettings');
        if (savedSettings) {
            currentSettings = JSON.parse(savedSettings);
            if (currentSettings.projectId && currentSettings.tableIds.length > 0) {
                elements.startProfilingButton.disabled = false;
                showWelcomeMessage();
                updateSelectedTablesNav();
                return;
            }
        }
        elements.startProfilingButton.disabled = true;
        showSettingsNeededMessage();
        updateSelectedTablesNav();
    }

    function showWelcomeMessage() {
        elements.messagesArea.innerHTML = `
            <div class="flex justify-center items-center h-full">
                <div class="text-center max-w-md">
                    <div class="text-6xl mb-4">ğŸ¤–</div>
                    <h2 class="text-2xl font-semibold text-gray-900 mb-2">BigQuery AI Assistant</h2>
                    <p class="text-gray-600 mb-6">'í”„ë¡œíŒŒì¼ë§ ì‹œì‘' ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°ì´í„° ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”.</p>
                </div>
            </div>`;
    }
    
    function showSettingsNeededMessage() {
         elements.messagesArea.innerHTML = `
            <div class="flex justify-center items-center h-full">
                <div class="text-center max-w-md">
                    <div class="text-6xl mb-4">âš™ï¸</div>
                    <h2 class="text-2xl font-semibold text-gray-900 mb-2">ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
                    <p class="text-gray-600 mb-6">ì¢Œì¸¡ ë©”ë‰´ì˜ <a href="/settings" class="text-blue-600 font-semibold">í”„ë¡œì íŠ¸ ì„¤ì •</a>ìœ¼ë¡œ ì´ë™í•˜ì—¬ ë¶„ì„í•  ëŒ€ìƒì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                </div>
            </div>`;
    }
    
    function startProfiling() {
        if (!currentSettings.projectId || currentSettings.tableIds.length === 0) {
            alert('ì„¤ì •ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì • í˜ì´ì§€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
            return;
        }

        elements.startProfilingButton.disabled = true;
        elements.startProfilingButton.textContent = 'í”„ë¡œíŒŒì¼ë§ ì¤‘...';
        elements.profilingStatusIndicator.className = 'status-indicator status-working';
        elements.profilingStatus.textContent = 'ì‹œì‘ ì¤‘...';

        const tableIdsParam = currentSettings.tableIds.join(',');
        const source = new EventSource(`/profiling?projectId=${encodeURIComponent(currentSettings.projectId)}&tableIds=${encodeURIComponent(tableIdsParam)}`);

        source.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            if (data.type === 'status') {
                elements.profilingStatus.textContent = data.payload.message;
            } else if (data.type === 'profiling_complete') {
                profilingCompleted = true;
                elements.profilingStatusIndicator.className = 'status-indicator status-ready';
                elements.profilingStatus.textContent = 'ì™„ë£Œ';
                elements.chatInput.disabled = false;
                elements.sendButton.disabled = false;
                elements.startProfilingButton.textContent = 'ë‹¤ì‹œ ì‹œì‘';
                elements.startProfilingButton.disabled = false;
                addMessage(data.payload.report.full_report, false, 'markdown');
                source.close();
            } else if (data.type === 'error') {
                elements.profilingStatusIndicator.className = 'status-indicator status-error';
                elements.profilingStatus.textContent = 'ì˜¤ë¥˜';
                addMessage(`**í”„ë¡œíŒŒì¼ë§ ì˜¤ë¥˜**\n\n${data.payload.message}`, false, 'markdown');
                source.close();
                elements.startProfilingButton.disabled = false;
                elements.startProfilingButton.textContent = 'ë‹¤ì‹œ ì‹œì‘';
            }
        };

        source.onerror = function(err) {
            elements.profilingStatusIndicator.className = 'status-indicator status-error';
            elements.profilingStatus.textContent = 'ì—°ê²° ì˜¤ë¥˜';
            source.close();
            elements.startProfilingButton.disabled = false;
            elements.startProfilingButton.textContent = 'ë‹¤ì‹œ ì‹œì‘';
        };
    }
    
    let isFirstMessage = true;
    function addMessage(content, isUser = false, type = 'text') {
        if (isFirstMessage) {
            elements.messagesArea.innerHTML = '';
            isFirstMessage = false;
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message-bubble p-4 ${isUser ? 'user-message' : 'ai-message'}`;
        
        if (type === 'markdown') {
            messageDiv.innerHTML = marked.parse(content);
        } else {
            messageDiv.textContent = content;
        }
        
        elements.messagesArea.appendChild(messageDiv);
        elements.messagesArea.scrollTop = elements.messagesArea.scrollHeight;
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadSettings();
        elements.startProfilingButton.addEventListener('click', startProfiling);
    });
</script>
{% endblock %}
